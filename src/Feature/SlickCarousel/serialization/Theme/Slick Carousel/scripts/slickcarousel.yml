---
ID: "a5dab22f-b77a-4224-9d77-5fd302cc9dca"
Parent: "ae4ff754-45d5-44dd-8865-4902f0f6695f"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Base Themes/Slick Carousel/scripts/slickcarousel
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/A5DAB22FB77A42249D775FD302CC9DCA.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "91700623-5cde-4d5d-9018-fb1b84b76206"
  Value: LyoNCiAgICAgXyBfICAgICAgXyAgICAgICBfDQogX19ffCAoXykgX19ffCB8IF9fICAoXylfX18NCi8gX198IHwgfC8gX198IHwvIC8gIHwgLyBfX3wNClxfXyBcIHwgfCAoX198ICAgPCBfIHwgXF9fIFwNCnxfX18vX3xffFxfX198X3xcXyhfKS8gfF9fXy8NCiAgICAgICAgICAgICAgICAgICB8X18vDQoNCiBWZXJzaW9uOiAxLjYuMA0KICBBdXRob3I6IEtlbiBXaGVlbGVyDQogV2Vic2l0ZTogaHR0cDovL2tlbndoZWVsZXIuZ2l0aHViLmlvDQogICAgRG9jczogaHR0cDovL2tlbndoZWVsZXIuZ2l0aHViLmlvL3NsaWNrDQogICAgUmVwbzogaHR0cDovL2dpdGh1Yi5jb20va2Vud2hlZWxlci9zbGljaw0KICBJc3N1ZXM6IGh0dHA6Ly9naXRodWIuY29tL2tlbndoZWVsZXIvc2xpY2svaXNzdWVzDQoNCiAqLw0KLyogZ2xvYmFsIHdpbmRvdywgZG9jdW1lbnQsIGRlZmluZSwgalF1ZXJ5LCBzZXRJbnRlcnZhbCwgY2xlYXJJbnRlcnZhbCAqLw0KKGZ1bmN0aW9uIChmYWN0b3J5KSB7DQogICAgJ3VzZSBzdHJpY3QnOw0KICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsNCiAgICAgICAgZGVmaW5lKFsnanF1ZXJ5J10sIGZhY3RvcnkpOw0KICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCdqcXVlcnknKSk7DQogICAgfSBlbHNlIHsNCiAgICAgICAgZmFjdG9yeShqUXVlcnkpOw0KICAgIH0NCg0KfShmdW5jdGlvbiAoJCkgew0KICAgICd1c2Ugc3RyaWN0JzsNCiAgICB2YXIgU2xpY2sgPSB3aW5kb3cuU2xpY2sgfHwge307DQoNCiAgICBTbGljayA9IChmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIGluc3RhbmNlVWlkID0gMDsNCg0KICAgICAgICBmdW5jdGlvbiBTbGljayhlbGVtZW50LCBzZXR0aW5ncykgew0KDQogICAgICAgICAgICB2YXIgXyA9IHRoaXMsIGRhdGFTZXR0aW5nczsNCg0KICAgICAgICAgICAgXy5kZWZhdWx0cyA9IHsNCiAgICAgICAgICAgICAgICBhY2Nlc3NpYmlsaXR5OiB0cnVlLA0KICAgICAgICAgICAgICAgIGFkYXB0aXZlSGVpZ2h0OiBmYWxzZSwNCiAgICAgICAgICAgICAgICBhcHBlbmRBcnJvd3M6ICQoZWxlbWVudCksDQogICAgICAgICAgICAgICAgYXBwZW5kRG90czogJChlbGVtZW50KSwNCiAgICAgICAgICAgICAgICBhcnJvd3M6IHRydWUsDQogICAgICAgICAgICAgICAgYXNOYXZGb3I6IG51bGwsDQogICAgICAgICAgICAgICAgcHJldkFycm93OiAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtcm9sZT0ibm9uZSIgY2xhc3M9InNsaWNrLXByZXYiIGFyaWEtbGFiZWw9IlByZXZpb3VzIiB0YWJpbmRleD0iMCIgcm9sZT0iYnV0dG9uIj5QcmV2aW91czwvYnV0dG9uPicsDQogICAgICAgICAgICAgICAgbmV4dEFycm93OiAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtcm9sZT0ibm9uZSIgY2xhc3M9InNsaWNrLW5leHQiIGFyaWEtbGFiZWw9Ik5leHQiIHRhYmluZGV4PSIwIiByb2xlPSJidXR0b24iPk5leHQ8L2J1dHRvbj4nLA0KICAgICAgICAgICAgICAgIGF1dG9wbGF5OiBmYWxzZSwNCiAgICAgICAgICAgICAgICBhdXRvcGxheVNwZWVkOiAzMDAwLA0KICAgICAgICAgICAgICAgIGNlbnRlck1vZGU6IGZhbHNlLA0KICAgICAgICAgICAgICAgIGNlbnRlclBhZGRpbmc6ICc1MHB4JywNCiAgICAgICAgICAgICAgICBjc3NFYXNlOiAnZWFzZScsDQogICAgICAgICAgICAgICAgY3VzdG9tUGFnaW5nOiBmdW5jdGlvbiAoc2xpZGVyLCBpKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAkKCc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1yb2xlPSJub25lIiByb2xlPSJidXR0b24iIHRhYmluZGV4PSIwIiAvPicpLnRleHQoaSArIDEpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZG90czogZmFsc2UsDQogICAgICAgICAgICAgICAgZG90c0NsYXNzOiAnc2xpY2stZG90cycsDQogICAgICAgICAgICAgICAgZHJhZ2dhYmxlOiB0cnVlLA0KICAgICAgICAgICAgICAgIGVhc2luZzogJ2xpbmVhcicsDQogICAgICAgICAgICAgICAgZWRnZUZyaWN0aW9uOiAwLjM1LA0KICAgICAgICAgICAgICAgIGZhZGU6IGZhbHNlLA0KICAgICAgICAgICAgICAgIGZvY3VzT25TZWxlY3Q6IGZhbHNlLA0KICAgICAgICAgICAgICAgIGluZmluaXRlOiB0cnVlLA0KICAgICAgICAgICAgICAgIGluaXRpYWxTbGlkZTogMCwNCiAgICAgICAgICAgICAgICBsYXp5TG9hZDogJ29uZGVtYW5kJywNCiAgICAgICAgICAgICAgICBtb2JpbGVGaXJzdDogZmFsc2UsDQogICAgICAgICAgICAgICAgcGF1c2VPbkhvdmVyOiB0cnVlLA0KICAgICAgICAgICAgICAgIHBhdXNlT25Gb2N1czogdHJ1ZSwNCiAgICAgICAgICAgICAgICBwYXVzZU9uRG90c0hvdmVyOiBmYWxzZSwNCiAgICAgICAgICAgICAgICByZXNwb25kVG86ICd3aW5kb3cnLA0KICAgICAgICAgICAgICAgIHJlc3BvbnNpdmU6IG51bGwsDQogICAgICAgICAgICAgICAgcm93czogMSwNCiAgICAgICAgICAgICAgICBydGw6IGZhbHNlLA0KICAgICAgICAgICAgICAgIHNsaWRlOiAnJywNCiAgICAgICAgICAgICAgICBzbGlkZXNQZXJSb3c6IDEsDQogICAgICAgICAgICAgICAgc2xpZGVzVG9TaG93OiAxLA0KICAgICAgICAgICAgICAgIHNsaWRlc1RvU2Nyb2xsOiAxLA0KICAgICAgICAgICAgICAgIHNwZWVkOiA1MDAsDQogICAgICAgICAgICAgICAgc3dpcGU6IHRydWUsDQogICAgICAgICAgICAgICAgc3dpcGVUb1NsaWRlOiBmYWxzZSwNCiAgICAgICAgICAgICAgICB0b3VjaE1vdmU6IHRydWUsDQogICAgICAgICAgICAgICAgdG91Y2hUaHJlc2hvbGQ6IDUsDQogICAgICAgICAgICAgICAgdXNlQ1NTOiB0cnVlLA0KICAgICAgICAgICAgICAgIHVzZVRyYW5zZm9ybTogdHJ1ZSwNCiAgICAgICAgICAgICAgICB2YXJpYWJsZVdpZHRoOiBmYWxzZSwNCiAgICAgICAgICAgICAgICB2ZXJ0aWNhbDogZmFsc2UsDQogICAgICAgICAgICAgICAgdmVydGljYWxTd2lwaW5nOiBmYWxzZSwNCiAgICAgICAgICAgICAgICB3YWl0Rm9yQW5pbWF0ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICB6SW5kZXg6IDEwMDANCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIF8uaW5pdGlhbHMgPSB7DQogICAgICAgICAgICAgICAgYW5pbWF0aW5nOiBmYWxzZSwNCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogZmFsc2UsDQogICAgICAgICAgICAgICAgYXV0b1BsYXlUaW1lcjogbnVsbCwNCiAgICAgICAgICAgICAgICBjdXJyZW50RGlyZWN0aW9uOiAwLA0KICAgICAgICAgICAgICAgIGN1cnJlbnRMZWZ0OiBudWxsLA0KICAgICAgICAgICAgICAgIGN1cnJlbnRTbGlkZTogMCwNCiAgICAgICAgICAgICAgICBkaXJlY3Rpb246IDEsDQogICAgICAgICAgICAgICAgJGRvdHM6IG51bGwsDQogICAgICAgICAgICAgICAgbGlzdFdpZHRoOiBudWxsLA0KICAgICAgICAgICAgICAgIGxpc3RIZWlnaHQ6IG51bGwsDQogICAgICAgICAgICAgICAgbG9hZEluZGV4OiAwLA0KICAgICAgICAgICAgICAgICRuZXh0QXJyb3c6IG51bGwsDQogICAgICAgICAgICAgICAgJHByZXZBcnJvdzogbnVsbCwNCiAgICAgICAgICAgICAgICBzbGlkZUNvdW50OiBudWxsLA0KICAgICAgICAgICAgICAgIHNsaWRlV2lkdGg6IG51bGwsDQogICAgICAgICAgICAgICAgJHNsaWRlVHJhY2s6IG51bGwsDQogICAgICAgICAgICAgICAgJHNsaWRlczogbnVsbCwNCiAgICAgICAgICAgICAgICBzbGlkaW5nOiBmYWxzZSwNCiAgICAgICAgICAgICAgICBzbGlkZU9mZnNldDogMCwNCiAgICAgICAgICAgICAgICBzd2lwZUxlZnQ6IG51bGwsDQogICAgICAgICAgICAgICAgJGxpc3Q6IG51bGwsDQogICAgICAgICAgICAgICAgdG91Y2hPYmplY3Q6IHt9LA0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybXNFbmFibGVkOiBmYWxzZSwNCiAgICAgICAgICAgICAgICB1bnNsaWNrZWQ6IGZhbHNlDQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAkLmV4dGVuZChfLCBfLmluaXRpYWxzKTsNCg0KICAgICAgICAgICAgXy5hY3RpdmVCcmVha3BvaW50ID0gbnVsbDsNCiAgICAgICAgICAgIF8uYW5pbVR5cGUgPSBudWxsOw0KICAgICAgICAgICAgXy5hbmltUHJvcCA9IG51bGw7DQogICAgICAgICAgICBfLmJyZWFrcG9pbnRzID0gW107DQogICAgICAgICAgICBfLmJyZWFrcG9pbnRTZXR0aW5ncyA9IFtdOw0KICAgICAgICAgICAgXy5jc3NUcmFuc2l0aW9ucyA9IGZhbHNlOw0KICAgICAgICAgICAgXy5mb2N1c3NlZCA9IGZhbHNlOw0KICAgICAgICAgICAgXy5pbnRlcnJ1cHRlZCA9IGZhbHNlOw0KICAgICAgICAgICAgXy5oaWRkZW4gPSAnaGlkZGVuJzsNCiAgICAgICAgICAgIF8ucGF1c2VkID0gdHJ1ZTsNCiAgICAgICAgICAgIF8ucG9zaXRpb25Qcm9wID0gbnVsbDsNCiAgICAgICAgICAgIF8ucmVzcG9uZFRvID0gbnVsbDsNCiAgICAgICAgICAgIF8ucm93Q291bnQgPSAxOw0KICAgICAgICAgICAgXy5zaG91bGRDbGljayA9IHRydWU7DQogICAgICAgICAgICBfLiRzbGlkZXIgPSAkKGVsZW1lbnQpOw0KICAgICAgICAgICAgXy4kc2xpZGVzQ2FjaGUgPSBudWxsOw0KICAgICAgICAgICAgXy50cmFuc2Zvcm1UeXBlID0gbnVsbDsNCiAgICAgICAgICAgIF8udHJhbnNpdGlvblR5cGUgPSBudWxsOw0KICAgICAgICAgICAgXy52aXNpYmlsaXR5Q2hhbmdlID0gJ3Zpc2liaWxpdHljaGFuZ2UnOw0KICAgICAgICAgICAgXy53aW5kb3dXaWR0aCA9IDA7DQogICAgICAgICAgICBfLndpbmRvd1RpbWVyID0gbnVsbDsNCg0KICAgICAgICAgICAgZGF0YVNldHRpbmdzID0gJChlbGVtZW50KS5kYXRhKCdzbGljaycpIHx8IHt9Ow0KDQogICAgICAgICAgICBfLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgXy5kZWZhdWx0cywgc2V0dGluZ3MsIGRhdGFTZXR0aW5ncyk7DQoNCiAgICAgICAgICAgIF8uY3VycmVudFNsaWRlID0gXy5vcHRpb25zLmluaXRpYWxTbGlkZTsNCg0KICAgICAgICAgICAgXy5vcmlnaW5hbFNldHRpbmdzID0gXy5vcHRpb25zOw0KDQogICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50Lm1vekhpZGRlbiAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgICBfLmhpZGRlbiA9ICdtb3pIaWRkZW4nOw0KICAgICAgICAgICAgICAgIF8udmlzaWJpbGl0eUNoYW5nZSA9ICdtb3p2aXNpYmlsaXR5Y2hhbmdlJzsNCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRvY3VtZW50LndlYmtpdEhpZGRlbiAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgICBfLmhpZGRlbiA9ICd3ZWJraXRIaWRkZW4nOw0KICAgICAgICAgICAgICAgIF8udmlzaWJpbGl0eUNoYW5nZSA9ICd3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlJzsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgXy5hdXRvUGxheSA9ICQucHJveHkoXy5hdXRvUGxheSwgXyk7DQogICAgICAgICAgICBfLmF1dG9QbGF5Q2xlYXIgPSAkLnByb3h5KF8uYXV0b1BsYXlDbGVhciwgXyk7DQogICAgICAgICAgICBfLmF1dG9QbGF5SXRlcmF0b3IgPSAkLnByb3h5KF8uYXV0b1BsYXlJdGVyYXRvciwgXyk7DQogICAgICAgICAgICBfLmNoYW5nZVNsaWRlID0gJC5wcm94eShfLmNoYW5nZVNsaWRlLCBfKTsNCiAgICAgICAgICAgIF8uY2xpY2tIYW5kbGVyID0gJC5wcm94eShfLmNsaWNrSGFuZGxlciwgXyk7DQogICAgICAgICAgICBfLnNlbGVjdEhhbmRsZXIgPSAkLnByb3h5KF8uc2VsZWN0SGFuZGxlciwgXyk7DQogICAgICAgICAgICBfLnNldFBvc2l0aW9uID0gJC5wcm94eShfLnNldFBvc2l0aW9uLCBfKTsNCiAgICAgICAgICAgIF8uc3dpcGVIYW5kbGVyID0gJC5wcm94eShfLnN3aXBlSGFuZGxlciwgXyk7DQogICAgICAgICAgICBfLmRyYWdIYW5kbGVyID0gJC5wcm94eShfLmRyYWdIYW5kbGVyLCBfKTsNCiAgICAgICAgICAgIF8ua2V5SGFuZGxlciA9ICQucHJveHkoXy5rZXlIYW5kbGVyLCBfKTsNCg0KICAgICAgICAgICAgXy5pbnN0YW5jZVVpZCA9IGluc3RhbmNlVWlkKys7DQoNCiAgICAgICAgICAgIC8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzDQogICAgICAgICAgICAvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAobXVzdCBzdGFydCB3aXRoIDwpDQogICAgICAgICAgICAvLyBFeHRyYWN0ZWQgZnJvbSBqUXVlcnkgdjEuMTEgc291cmNlDQogICAgICAgICAgICBfLmh0bWxFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qKSQvOw0KDQoNCiAgICAgICAgICAgIF8ucmVnaXN0ZXJCcmVha3BvaW50cygpOw0KICAgICAgICAgICAgXy5pbml0KHRydWUpOw0KDQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gU2xpY2s7DQoNCiAgICB9KCkpOw0KDQogICAgU2xpY2sucHJvdG90eXBlLmFjdGl2YXRlQURBID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy4kc2xpZGVUcmFjay5maW5kKCcuc2xpY2stYWN0aXZlJykuYXR0cih7DQogICAgICAgICAgICAnYXJpYS1oaWRkZW4nOiAnZmFsc2UnDQogICAgICAgIH0pLmZpbmQoJ2EsIGlucHV0LCBidXR0b24sIHNlbGVjdCcpLmF0dHIoew0KICAgICAgICAgICAgJ3RhYmluZGV4JzogJzAnDQogICAgICAgIH0pOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5hZGRTbGlkZSA9IFNsaWNrLnByb3RvdHlwZS5zbGlja0FkZCA9IGZ1bmN0aW9uIChtYXJrdXAsIGluZGV4LCBhZGRCZWZvcmUpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHR5cGVvZiAoaW5kZXgpID09PSAnYm9vbGVhbicpIHsNCiAgICAgICAgICAgIGFkZEJlZm9yZSA9IGluZGV4Ow0KICAgICAgICAgICAgaW5kZXggPSBudWxsOw0KICAgICAgICB9IGVsc2UgaWYgKGluZGV4IDwgMCB8fCAoaW5kZXggPj0gXy5zbGlkZUNvdW50KSkgew0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgXy51bmxvYWQoKTsNCg0KICAgICAgICBpZiAodHlwZW9mIChpbmRleCkgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICBpZiAoaW5kZXggPT09IDAgJiYgXy4kc2xpZGVzLmxlbmd0aCA9PT0gMCkgew0KICAgICAgICAgICAgICAgICQobWFya3VwKS5hcHBlbmRUbyhfLiRzbGlkZVRyYWNrKTsNCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWRkQmVmb3JlKSB7DQogICAgICAgICAgICAgICAgJChtYXJrdXApLmluc2VydEJlZm9yZShfLiRzbGlkZXMuZXEoaW5kZXgpKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgJChtYXJrdXApLmluc2VydEFmdGVyKF8uJHNsaWRlcy5lcShpbmRleCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgaWYgKGFkZEJlZm9yZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgICQobWFya3VwKS5wcmVwZW5kVG8oXy4kc2xpZGVUcmFjayk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICQobWFya3VwKS5hcHBlbmRUbyhfLiRzbGlkZVRyYWNrKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIF8uJHNsaWRlcyA9IF8uJHNsaWRlVHJhY2suY2hpbGRyZW4odGhpcy5vcHRpb25zLnNsaWRlKTsNCg0KICAgICAgICBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5zbGlkZSkuZGV0YWNoKCk7DQoNCiAgICAgICAgXy4kc2xpZGVUcmFjay5hcHBlbmQoXy4kc2xpZGVzKTsNCg0KICAgICAgICBfLiRzbGlkZXMuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHsNCiAgICAgICAgICAgICQoZWxlbWVudCkuYXR0cignZGF0YS1zbGljay1pbmRleCcsIGluZGV4KTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgXy4kc2xpZGVzQ2FjaGUgPSBfLiRzbGlkZXM7DQoNCiAgICAgICAgXy5yZWluaXQoKTsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuYW5pbWF0ZUhlaWdodCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KICAgICAgICBpZiAoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyA9PT0gMSAmJiBfLm9wdGlvbnMuYWRhcHRpdmVIZWlnaHQgPT09IHRydWUgJiYgXy5vcHRpb25zLnZlcnRpY2FsID09PSBmYWxzZSkgew0KICAgICAgICAgICAgdmFyIHRhcmdldEhlaWdodCA9IF8uJHNsaWRlcy5lcShfLmN1cnJlbnRTbGlkZSkub3V0ZXJIZWlnaHQodHJ1ZSk7DQogICAgICAgICAgICBfLiRsaXN0LmFuaW1hdGUoew0KICAgICAgICAgICAgICAgIGhlaWdodDogdGFyZ2V0SGVpZ2h0DQogICAgICAgICAgICB9LCBfLm9wdGlvbnMuc3BlZWQpOw0KICAgICAgICB9DQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5hbmltYXRlU2xpZGUgPSBmdW5jdGlvbiAodGFyZ2V0TGVmdCwgY2FsbGJhY2spIHsNCg0KICAgICAgICB2YXIgYW5pbVByb3BzID0ge30sDQogICAgICAgICAgICBfID0gdGhpczsNCg0KICAgICAgICBfLmFuaW1hdGVIZWlnaHQoKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLnJ0bCA9PT0gdHJ1ZSAmJiBfLm9wdGlvbnMudmVydGljYWwgPT09IGZhbHNlKSB7DQogICAgICAgICAgICB0YXJnZXRMZWZ0ID0gLXRhcmdldExlZnQ7DQogICAgICAgIH0NCiAgICAgICAgaWYgKF8udHJhbnNmb3Jtc0VuYWJsZWQgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBpZiAoXy5vcHRpb25zLnZlcnRpY2FsID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIF8uJHNsaWRlVHJhY2suYW5pbWF0ZSh7DQogICAgICAgICAgICAgICAgICAgIGxlZnQ6IHRhcmdldExlZnQNCiAgICAgICAgICAgICAgICB9LCBfLm9wdGlvbnMuc3BlZWQsIF8ub3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgXy4kc2xpZGVUcmFjay5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgdG9wOiB0YXJnZXRMZWZ0DQogICAgICAgICAgICAgICAgfSwgXy5vcHRpb25zLnNwZWVkLCBfLm9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfSBlbHNlIHsNCg0KICAgICAgICAgICAgaWYgKF8uY3NzVHJhbnNpdGlvbnMgPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5ydGwgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgXy5jdXJyZW50TGVmdCA9IC0oXy5jdXJyZW50TGVmdCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICQoew0KICAgICAgICAgICAgICAgICAgICBhbmltU3RhcnQ6IF8uY3VycmVudExlZnQNCiAgICAgICAgICAgICAgICB9KS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgYW5pbVN0YXJ0OiB0YXJnZXRMZWZ0DQogICAgICAgICAgICAgICAgfSwgew0KICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IF8ub3B0aW9ucy5zcGVlZCwNCiAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogXy5vcHRpb25zLmVhc2luZywNCiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXA6IGZ1bmN0aW9uIChub3cpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3cgPSBNYXRoLmNlaWwobm93KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5vcHRpb25zLnZlcnRpY2FsID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltUHJvcHNbXy5hbmltVHlwZV0gPSAndHJhbnNsYXRlKCcgKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm93ICsgJ3B4LCAwcHgpJzsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy4kc2xpZGVUcmFjay5jc3MoYW5pbVByb3BzKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltUHJvcHNbXy5hbmltVHlwZV0gPSAndHJhbnNsYXRlKDBweCwnICsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdyArICdweCknOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNzcyhhbmltUHJvcHMpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZTogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgfSBlbHNlIHsNCg0KICAgICAgICAgICAgICAgIF8uYXBwbHlUcmFuc2l0aW9uKCk7DQogICAgICAgICAgICAgICAgdGFyZ2V0TGVmdCA9IE1hdGguY2VpbCh0YXJnZXRMZWZ0KTsNCg0KICAgICAgICAgICAgICAgIGlmIChfLm9wdGlvbnMudmVydGljYWwgPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgICAgIGFuaW1Qcm9wc1tfLmFuaW1UeXBlXSA9ICd0cmFuc2xhdGUzZCgnICsgdGFyZ2V0TGVmdCArICdweCwgMHB4LCAwcHgpJzsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBhbmltUHJvcHNbXy5hbmltVHlwZV0gPSAndHJhbnNsYXRlM2QoMHB4LCcgKyB0YXJnZXRMZWZ0ICsgJ3B4LCAwcHgpJzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgXy4kc2xpZGVUcmFjay5jc3MoYW5pbVByb3BzKTsNCg0KICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgew0KICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgXy5kaXNhYmxlVHJhbnNpdGlvbigpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKCk7DQogICAgICAgICAgICAgICAgICAgIH0sIF8ub3B0aW9ucy5zcGVlZCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5nZXROYXZUYXJnZXQgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgYXNOYXZGb3IgPSBfLm9wdGlvbnMuYXNOYXZGb3I7DQoNCiAgICAgICAgaWYgKGFzTmF2Rm9yICYmIGFzTmF2Rm9yICE9PSBudWxsKSB7DQogICAgICAgICAgICBhc05hdkZvciA9ICQoYXNOYXZGb3IpLm5vdChfLiRzbGlkZXIpOw0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIGFzTmF2Rm9yOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5hc05hdkZvciA9IGZ1bmN0aW9uIChpbmRleCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIGFzTmF2Rm9yID0gXy5nZXROYXZUYXJnZXQoKTsNCg0KICAgICAgICBpZiAoYXNOYXZGb3IgIT09IG51bGwgJiYgdHlwZW9mIGFzTmF2Rm9yID09PSAnb2JqZWN0Jykgew0KICAgICAgICAgICAgYXNOYXZGb3IuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9ICQodGhpcykuc2xpY2soJ2dldFNsaWNrJyk7DQogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQudW5zbGlja2VkKSB7DQogICAgICAgICAgICAgICAgICAgIHRhcmdldC5zbGlkZUhhbmRsZXIoaW5kZXgsIHRydWUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmFwcGx5VHJhbnNpdGlvbiA9IGZ1bmN0aW9uIChzbGlkZSkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIHRyYW5zaXRpb24gPSB7fTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmZhZGUgPT09IGZhbHNlKSB7DQogICAgICAgICAgICB0cmFuc2l0aW9uW18udHJhbnNpdGlvblR5cGVdID0gXy50cmFuc2Zvcm1UeXBlICsgJyAnICsgXy5vcHRpb25zLnNwZWVkICsgJ21zICcgKyBfLm9wdGlvbnMuY3NzRWFzZTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHRyYW5zaXRpb25bXy50cmFuc2l0aW9uVHlwZV0gPSAnb3BhY2l0eSAnICsgXy5vcHRpb25zLnNwZWVkICsgJ21zICcgKyBfLm9wdGlvbnMuY3NzRWFzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuZmFkZSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIF8uJHNsaWRlVHJhY2suY3NzKHRyYW5zaXRpb24pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgXy4kc2xpZGVzLmVxKHNsaWRlKS5jc3ModHJhbnNpdGlvbik7DQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuYXV0b1BsYXkgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIF8uYXV0b1BsYXlDbGVhcigpOw0KDQogICAgICAgIGlmIChfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQogICAgICAgICAgICBfLmF1dG9QbGF5VGltZXIgPSBzZXRJbnRlcnZhbChfLmF1dG9QbGF5SXRlcmF0b3IsIF8ub3B0aW9ucy5hdXRvcGxheVNwZWVkKTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5hdXRvUGxheUNsZWFyID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5hdXRvUGxheVRpbWVyKSB7DQogICAgICAgICAgICBjbGVhckludGVydmFsKF8uYXV0b1BsYXlUaW1lcik7DQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuYXV0b1BsYXlJdGVyYXRvciA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXMsDQogICAgICAgICAgICBzbGlkZVRvID0gXy5jdXJyZW50U2xpZGUgKyBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGw7DQoNCiAgICAgICAgaWYgKCFfLnBhdXNlZCAmJiAhXy5pbnRlcnJ1cHRlZCAmJiAhXy5mb2N1c3NlZCkgew0KDQogICAgICAgICAgICBpZiAoXy5vcHRpb25zLmluZmluaXRlID09PSBmYWxzZSkgew0KDQogICAgICAgICAgICAgICAgaWYgKF8uZGlyZWN0aW9uID09PSAxICYmIChfLmN1cnJlbnRTbGlkZSArIDEpID09PSAoXy5zbGlkZUNvdW50IC0gMSkpIHsNCiAgICAgICAgICAgICAgICAgICAgXy5kaXJlY3Rpb24gPSAwOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uZGlyZWN0aW9uID09PSAwKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgc2xpZGVUbyA9IF8uY3VycmVudFNsaWRlIC0gXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsOw0KDQogICAgICAgICAgICAgICAgICAgIGlmIChfLmN1cnJlbnRTbGlkZSAtIDEgPT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIF8uZGlyZWN0aW9uID0gMTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIF8uc2xpZGVIYW5kbGVyKHNsaWRlVG8pOw0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuYnVpbGRBcnJvd3MgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuYXJyb3dzID09PSB0cnVlKSB7DQoNCiAgICAgICAgICAgIF8uJHByZXZBcnJvdyA9ICQoXy5vcHRpb25zLnByZXZBcnJvdykuYWRkQ2xhc3MoJ3NsaWNrLWFycm93Jyk7DQogICAgICAgICAgICBfLiRuZXh0QXJyb3cgPSAkKF8ub3B0aW9ucy5uZXh0QXJyb3cpLmFkZENsYXNzKCdzbGljay1hcnJvdycpOw0KDQogICAgICAgICAgICBpZiAoXy5zbGlkZUNvdW50ID4gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KDQogICAgICAgICAgICAgICAgXy4kcHJldkFycm93LnJlbW92ZUNsYXNzKCdzbGljay1oaWRkZW4nKS5yZW1vdmVBdHRyKCdhcmlhLWhpZGRlbiB0YWJpbmRleCcpOw0KICAgICAgICAgICAgICAgIF8uJG5leHRBcnJvdy5yZW1vdmVDbGFzcygnc2xpY2staGlkZGVuJykucmVtb3ZlQXR0cignYXJpYS1oaWRkZW4gdGFiaW5kZXgnKTsNCg0KICAgICAgICAgICAgICAgIGlmIChfLmh0bWxFeHByLnRlc3QoXy5vcHRpb25zLnByZXZBcnJvdykpIHsNCiAgICAgICAgICAgICAgICAgICAgXy4kcHJldkFycm93LnByZXBlbmRUbyhfLm9wdGlvbnMuYXBwZW5kQXJyb3dzKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZiAoXy5odG1sRXhwci50ZXN0KF8ub3B0aW9ucy5uZXh0QXJyb3cpKSB7DQogICAgICAgICAgICAgICAgICAgIF8uJG5leHRBcnJvdy5hcHBlbmRUbyhfLm9wdGlvbnMuYXBwZW5kQXJyb3dzKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZiAoXy5vcHRpb25zLmluZmluaXRlICE9PSB0cnVlKSB7DQogICAgICAgICAgICAgICAgICAgIF8uJHByZXZBcnJvdw0KICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdzbGljay1kaXNhYmxlZCcpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignYXJpYS1kaXNhYmxlZCcsICd0cnVlJyk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9IGVsc2Ugew0KDQogICAgICAgICAgICAgICAgXy4kcHJldkFycm93LmFkZChfLiRuZXh0QXJyb3cpDQoNCiAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdzbGljay1oaWRkZW4nKQ0KICAgICAgICAgICAgICAgICAgICAuYXR0cih7DQogICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS1kaXNhYmxlZCc6ICd0cnVlJywNCiAgICAgICAgICAgICAgICAgICAgICAgICd0YWJpbmRleCc6ICctMScNCiAgICAgICAgICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmJ1aWxkRG90cyA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXMsDQogICAgICAgICAgICBpLCBkb3Q7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5kb3RzID09PSB0cnVlICYmIF8uc2xpZGVDb3VudCA+IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCg0KICAgICAgICAgICAgXy4kc2xpZGVyLmFkZENsYXNzKCdzbGljay1kb3R0ZWQnKTsNCg0KICAgICAgICAgICAgZG90ID0gJCgnPHVsIC8+JykuYWRkQ2xhc3MoXy5vcHRpb25zLmRvdHNDbGFzcyk7DQoNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPD0gXy5nZXREb3RDb3VudCgpOyBpICs9IDEpIHsNCiAgICAgICAgICAgICAgICBkb3QuYXBwZW5kKCQoJzxsaSAvPicpLmFwcGVuZChfLm9wdGlvbnMuY3VzdG9tUGFnaW5nLmNhbGwodGhpcywgXywgaSkpKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgXy4kZG90cyA9IGRvdC5hcHBlbmRUbyhfLm9wdGlvbnMuYXBwZW5kRG90cyk7DQoNCiAgICAgICAgICAgIF8uJGRvdHMuZmluZCgnbGknKS5maXJzdCgpLmFkZENsYXNzKCdzbGljay1hY3RpdmUnKS5hdHRyKCdhcmlhLWhpZGRlbicsICdmYWxzZScpOw0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuYnVpbGRPdXQgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIF8uJHNsaWRlcyA9DQogICAgICAgICAgICBfLiRzbGlkZXINCiAgICAgICAgICAgICAgICAuY2hpbGRyZW4oXy5vcHRpb25zLnNsaWRlICsgJzpub3QoLnNsaWNrLWNsb25lZCknKQ0KICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc2xpY2stc2xpZGUnKTsNCg0KICAgICAgICBfLnNsaWRlQ291bnQgPSBfLiRzbGlkZXMubGVuZ3RoOw0KDQogICAgICAgIF8uJHNsaWRlcy5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkgew0KICAgICAgICAgICAgJChlbGVtZW50KQ0KICAgICAgICAgICAgICAgIC5hdHRyKCdkYXRhLXNsaWNrLWluZGV4JywgaW5kZXgpDQogICAgICAgICAgICAgICAgLmRhdGEoJ29yaWdpbmFsU3R5bGluZycsICQoZWxlbWVudCkuYXR0cignc3R5bGUnKSB8fCAnJyk7DQogICAgICAgIH0pOw0KDQogICAgICAgIF8uJHNsaWRlci5hZGRDbGFzcygnc2xpY2stc2xpZGVyJyk7DQoNCiAgICAgICAgXy4kc2xpZGVUcmFjayA9IChfLnNsaWRlQ291bnQgPT09IDApID8NCiAgICAgICAgICAgICQoJzxkaXYgY2xhc3M9InNsaWNrLXRyYWNrIi8+JykuYXBwZW5kVG8oXy4kc2xpZGVyKSA6DQogICAgICAgICAgICBfLiRzbGlkZXMud3JhcEFsbCgnPGRpdiBjbGFzcz0ic2xpY2stdHJhY2siLz4nKS5wYXJlbnQoKTsNCg0KICAgICAgICBfLiRsaXN0ID0gXy4kc2xpZGVUcmFjay53cmFwKA0KICAgICAgICAgICAgJzxkaXYgYXJpYS1saXZlPSJwb2xpdGUiIGNsYXNzPSJzbGljay1saXN0Ii8+JykucGFyZW50KCk7DQogICAgICAgIF8uJHNsaWRlVHJhY2suY3NzKCdvcGFjaXR5JywgMCk7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSB0cnVlIHx8IF8ub3B0aW9ucy5zd2lwZVRvU2xpZGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCA9IDE7DQogICAgICAgIH0NCg0KICAgICAgICAkKCdpbWdbZGF0YS1sYXp5XScsIF8uJHNsaWRlcikubm90KCdbc3JjXScpLmFkZENsYXNzKCdzbGljay1sb2FkaW5nJyk7DQoNCiAgICAgICAgXy5zZXR1cEluZmluaXRlKCk7DQoNCiAgICAgICAgXy5idWlsZEFycm93cygpOw0KDQogICAgICAgIF8uYnVpbGREb3RzKCk7DQoNCiAgICAgICAgXy51cGRhdGVEb3RzKCk7DQoNCg0KICAgICAgICBfLnNldFNsaWRlQ2xhc3Nlcyh0eXBlb2YgXy5jdXJyZW50U2xpZGUgPT09ICdudW1iZXInID8gXy5jdXJyZW50U2xpZGUgOiAwKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmRyYWdnYWJsZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy4kbGlzdC5hZGRDbGFzcygnZHJhZ2dhYmxlJyk7DQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuYnVpbGRSb3dzID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywgYSwgYiwgYywgbmV3U2xpZGVzLCBudW1PZlNsaWRlcywgb3JpZ2luYWxTbGlkZXMsIHNsaWRlc1BlclNlY3Rpb247DQoNCiAgICAgICAgbmV3U2xpZGVzID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOw0KICAgICAgICBvcmlnaW5hbFNsaWRlcyA9IF8uJHNsaWRlci5jaGlsZHJlbigpOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMucm93cyA+IDEpIHsNCg0KICAgICAgICAgICAgc2xpZGVzUGVyU2VjdGlvbiA9IF8ub3B0aW9ucy5zbGlkZXNQZXJSb3cgKiBfLm9wdGlvbnMucm93czsNCiAgICAgICAgICAgIG51bU9mU2xpZGVzID0gTWF0aC5jZWlsKA0KICAgICAgICAgICAgICAgIG9yaWdpbmFsU2xpZGVzLmxlbmd0aCAvIHNsaWRlc1BlclNlY3Rpb24NCiAgICAgICAgICAgICk7DQoNCiAgICAgICAgICAgIGZvciAoYSA9IDA7IGEgPCBudW1PZlNsaWRlczsgYSsrKSB7DQogICAgICAgICAgICAgICAgdmFyIHNsaWRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7DQogICAgICAgICAgICAgICAgZm9yIChiID0gMDsgYiA8IF8ub3B0aW9ucy5yb3dzOyBiKyspIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOw0KICAgICAgICAgICAgICAgICAgICBmb3IgKGMgPSAwOyBjIDwgXy5vcHRpb25zLnNsaWRlc1BlclJvdzsgYysrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gKGEgKiBzbGlkZXNQZXJTZWN0aW9uICsgKChiICogXy5vcHRpb25zLnNsaWRlc1BlclJvdykgKyBjKSk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3JpZ2luYWxTbGlkZXMuZ2V0KHRhcmdldCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3cuYXBwZW5kQ2hpbGQob3JpZ2luYWxTbGlkZXMuZ2V0KHRhcmdldCkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHNsaWRlLmFwcGVuZENoaWxkKHJvdyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIG5ld1NsaWRlcy5hcHBlbmRDaGlsZChzbGlkZSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIF8uJHNsaWRlci5lbXB0eSgpLmFwcGVuZChuZXdTbGlkZXMpOw0KICAgICAgICAgICAgXy4kc2xpZGVyLmNoaWxkcmVuKCkuY2hpbGRyZW4oKS5jaGlsZHJlbigpDQogICAgICAgICAgICAgICAgLmNzcyh7DQogICAgICAgICAgICAgICAgICAgICd3aWR0aCc6ICgxMDAgLyBfLm9wdGlvbnMuc2xpZGVzUGVyUm93KSArICclJywNCiAgICAgICAgICAgICAgICAgICAgJ2Rpc3BsYXknOiAnaW5saW5lLWJsb2NrJw0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuY2hlY2tSZXNwb25zaXZlID0gZnVuY3Rpb24gKGluaXRpYWwsIGZvcmNlVXBkYXRlKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgYnJlYWtwb2ludCwgdGFyZ2V0QnJlYWtwb2ludCwgcmVzcG9uZFRvV2lkdGgsIHRyaWdnZXJCcmVha3BvaW50ID0gZmFsc2U7DQogICAgICAgIHZhciBzbGlkZXJXaWR0aCA9IF8uJHNsaWRlci53aWR0aCgpOw0KICAgICAgICB2YXIgd2luZG93V2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkKHdpbmRvdykud2lkdGgoKTsNCg0KICAgICAgICBpZiAoXy5yZXNwb25kVG8gPT09ICd3aW5kb3cnKSB7DQogICAgICAgICAgICByZXNwb25kVG9XaWR0aCA9IHdpbmRvd1dpZHRoOw0KICAgICAgICB9IGVsc2UgaWYgKF8ucmVzcG9uZFRvID09PSAnc2xpZGVyJykgew0KICAgICAgICAgICAgcmVzcG9uZFRvV2lkdGggPSBzbGlkZXJXaWR0aDsNCiAgICAgICAgfSBlbHNlIGlmIChfLnJlc3BvbmRUbyA9PT0gJ21pbicpIHsNCiAgICAgICAgICAgIHJlc3BvbmRUb1dpZHRoID0gTWF0aC5taW4od2luZG93V2lkdGgsIHNsaWRlcldpZHRoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMucmVzcG9uc2l2ZSAmJg0KICAgICAgICAgICAgXy5vcHRpb25zLnJlc3BvbnNpdmUubGVuZ3RoICYmDQogICAgICAgICAgICBfLm9wdGlvbnMucmVzcG9uc2l2ZSAhPT0gbnVsbCkgew0KDQogICAgICAgICAgICB0YXJnZXRCcmVha3BvaW50ID0gbnVsbDsNCg0KICAgICAgICAgICAgZm9yIChicmVha3BvaW50IGluIF8uYnJlYWtwb2ludHMpIHsNCiAgICAgICAgICAgICAgICBpZiAoXy5icmVha3BvaW50cy5oYXNPd25Qcm9wZXJ0eShicmVha3BvaW50KSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoXy5vcmlnaW5hbFNldHRpbmdzLm1vYmlsZUZpcnN0ID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbmRUb1dpZHRoIDwgXy5icmVha3BvaW50c1ticmVha3BvaW50XSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEJyZWFrcG9pbnQgPSBfLmJyZWFrcG9pbnRzW2JyZWFrcG9pbnRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbmRUb1dpZHRoID4gXy5icmVha3BvaW50c1ticmVha3BvaW50XSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEJyZWFrcG9pbnQgPSBfLmJyZWFrcG9pbnRzW2JyZWFrcG9pbnRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAodGFyZ2V0QnJlYWtwb2ludCAhPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIGlmIChfLmFjdGl2ZUJyZWFrcG9pbnQgIT09IG51bGwpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldEJyZWFrcG9pbnQgIT09IF8uYWN0aXZlQnJlYWtwb2ludCB8fCBmb3JjZVVwZGF0ZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgXy5hY3RpdmVCcmVha3BvaW50ID0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRCcmVha3BvaW50Ow0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uYnJlYWtwb2ludFNldHRpbmdzW3RhcmdldEJyZWFrcG9pbnRdID09PSAndW5zbGljaycpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLnVuc2xpY2sodGFyZ2V0QnJlYWtwb2ludCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8ub3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBfLm9yaWdpbmFsU2V0dGluZ3MsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uYnJlYWtwb2ludFNldHRpbmdzWw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRCcmVha3BvaW50XSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRpYWwgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5jdXJyZW50U2xpZGUgPSBfLm9wdGlvbnMuaW5pdGlhbFNsaWRlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLnJlZnJlc2goaW5pdGlhbCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyQnJlYWtwb2ludCA9IHRhcmdldEJyZWFrcG9pbnQ7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBfLmFjdGl2ZUJyZWFrcG9pbnQgPSB0YXJnZXRCcmVha3BvaW50Ow0KICAgICAgICAgICAgICAgICAgICBpZiAoXy5icmVha3BvaW50U2V0dGluZ3NbdGFyZ2V0QnJlYWtwb2ludF0gPT09ICd1bnNsaWNrJykgew0KICAgICAgICAgICAgICAgICAgICAgICAgXy51bnNsaWNrKHRhcmdldEJyZWFrcG9pbnQpOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgXy5vcHRpb25zID0gJC5leHRlbmQoe30sIF8ub3JpZ2luYWxTZXR0aW5ncywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmJyZWFrcG9pbnRTZXR0aW5nc1sNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRCcmVha3BvaW50XSk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbCA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uY3VycmVudFNsaWRlID0gXy5vcHRpb25zLmluaXRpYWxTbGlkZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIF8ucmVmcmVzaChpbml0aWFsKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyQnJlYWtwb2ludCA9IHRhcmdldEJyZWFrcG9pbnQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBpZiAoXy5hY3RpdmVCcmVha3BvaW50ICE9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgICAgIF8uYWN0aXZlQnJlYWtwb2ludCA9IG51bGw7DQogICAgICAgICAgICAgICAgICAgIF8ub3B0aW9ucyA9IF8ub3JpZ2luYWxTZXR0aW5nczsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRpYWwgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIF8uY3VycmVudFNsaWRlID0gXy5vcHRpb25zLmluaXRpYWxTbGlkZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBfLnJlZnJlc2goaW5pdGlhbCk7DQogICAgICAgICAgICAgICAgICAgIHRyaWdnZXJCcmVha3BvaW50ID0gdGFyZ2V0QnJlYWtwb2ludDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIG9ubHkgdHJpZ2dlciBicmVha3BvaW50cyBkdXJpbmcgYW4gYWN0dWFsIGJyZWFrLiBub3Qgb24gaW5pdGlhbGl6ZS4NCiAgICAgICAgICAgIGlmICghaW5pdGlhbCAmJiB0cmlnZ2VyQnJlYWtwb2ludCAhPT0gZmFsc2UpIHsNCiAgICAgICAgICAgICAgICBfLiRzbGlkZXIudHJpZ2dlcignYnJlYWtwb2ludCcsIFtfLCB0cmlnZ2VyQnJlYWtwb2ludF0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmNoYW5nZVNsaWRlID0gZnVuY3Rpb24gKGV2ZW50LCBkb250QW5pbWF0ZSkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgICR0YXJnZXQgPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpLA0KICAgICAgICAgICAgaW5kZXhPZmZzZXQsIHNsaWRlT2Zmc2V0LCB1bmV2ZW5PZmZzZXQ7DQoNCiAgICAgICAgLy8gSWYgdGFyZ2V0IGlzIGEgbGluaywgcHJldmVudCBkZWZhdWx0IGFjdGlvbi4NCiAgICAgICAgaWYgKCR0YXJnZXQuaXMoJ2EnKSkgew0KICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIElmIHRhcmdldCBpcyBub3QgdGhlIDxsaT4gZWxlbWVudCAoaWU6IGEgY2hpbGQpLCBmaW5kIHRoZSA8bGk+Lg0KICAgICAgICBpZiAoISR0YXJnZXQuaXMoJ2xpJykpIHsNCiAgICAgICAgICAgICR0YXJnZXQgPSAkdGFyZ2V0LmNsb3Nlc3QoJ2xpJyk7DQogICAgICAgIH0NCg0KICAgICAgICB1bmV2ZW5PZmZzZXQgPSAoXy5zbGlkZUNvdW50ICUgXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsICE9PSAwKTsNCiAgICAgICAgaW5kZXhPZmZzZXQgPSB1bmV2ZW5PZmZzZXQgPyAwIDogKF8uc2xpZGVDb3VudCAtIF8uY3VycmVudFNsaWRlKSAlIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbDsNCg0KICAgICAgICBzd2l0Y2ggKGV2ZW50LmRhdGEubWVzc2FnZSkgew0KDQogICAgICAgICAgICBjYXNlICdwcmV2aW91cyc6DQogICAgICAgICAgICAgICAgc2xpZGVPZmZzZXQgPSBpbmRleE9mZnNldCA9PT0gMCA/IF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCA6IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgLSBpbmRleE9mZnNldDsNCiAgICAgICAgICAgICAgICBpZiAoXy5zbGlkZUNvdW50ID4gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KICAgICAgICAgICAgICAgICAgICBfLnNsaWRlSGFuZGxlcihfLmN1cnJlbnRTbGlkZSAtIHNsaWRlT2Zmc2V0LCBmYWxzZSwgZG9udEFuaW1hdGUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgY2FzZSAnbmV4dCc6DQogICAgICAgICAgICAgICAgc2xpZGVPZmZzZXQgPSBpbmRleE9mZnNldCA9PT0gMCA/IF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCA6IGluZGV4T2Zmc2V0Ow0KICAgICAgICAgICAgICAgIGlmIChfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQogICAgICAgICAgICAgICAgICAgIF8uc2xpZGVIYW5kbGVyKF8uY3VycmVudFNsaWRlICsgc2xpZGVPZmZzZXQsIGZhbHNlLCBkb250QW5pbWF0ZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICBjYXNlICdpbmRleCc6DQogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZXZlbnQuZGF0YS5pbmRleCA9PT0gMCA/IDAgOg0KICAgICAgICAgICAgICAgICAgICBldmVudC5kYXRhLmluZGV4IHx8ICR0YXJnZXQuaW5kZXgoKSAqIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbDsNCg0KICAgICAgICAgICAgICAgIF8uc2xpZGVIYW5kbGVyKF8uY2hlY2tOYXZpZ2FibGUoaW5kZXgpLCBmYWxzZSwgZG9udEFuaW1hdGUpOw0KICAgICAgICAgICAgICAgICR0YXJnZXQuY2hpbGRyZW4oKS50cmlnZ2VyKCdmb2N1cycpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5jaGVja05hdmlnYWJsZSA9IGZ1bmN0aW9uIChpbmRleCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIG5hdmlnYWJsZXMsIHByZXZOYXZpZ2FibGU7DQoNCiAgICAgICAgbmF2aWdhYmxlcyA9IF8uZ2V0TmF2aWdhYmxlSW5kZXhlcygpOw0KICAgICAgICBwcmV2TmF2aWdhYmxlID0gMDsNCiAgICAgICAgaWYgKGluZGV4ID4gbmF2aWdhYmxlc1tuYXZpZ2FibGVzLmxlbmd0aCAtIDFdKSB7DQogICAgICAgICAgICBpbmRleCA9IG5hdmlnYWJsZXNbbmF2aWdhYmxlcy5sZW5ndGggLSAxXTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGZvciAodmFyIG4gaW4gbmF2aWdhYmxlcykgew0KICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IG5hdmlnYWJsZXNbbl0pIHsNCiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBwcmV2TmF2aWdhYmxlOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcHJldk5hdmlnYWJsZSA9IG5hdmlnYWJsZXNbbl07DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gaW5kZXg7DQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5jbGVhblVwRXZlbnRzID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmRvdHMgJiYgXy4kZG90cyAhPT0gbnVsbCkgew0KDQogICAgICAgICAgICAkKCdsaScsIF8uJGRvdHMpDQogICAgICAgICAgICAgICAgLm9mZignY2xpY2suc2xpY2snLCBfLmNoYW5nZVNsaWRlKQ0KICAgICAgICAgICAgICAgIC5vZmYoJ21vdXNlZW50ZXIuc2xpY2snLCAkLnByb3h5KF8uaW50ZXJydXB0LCBfLCB0cnVlKSkNCiAgICAgICAgICAgICAgICAub2ZmKCdtb3VzZWxlYXZlLnNsaWNrJywgJC5wcm94eShfLmludGVycnVwdCwgXywgZmFsc2UpKTsNCg0KICAgICAgICB9DQoNCiAgICAgICAgXy4kc2xpZGVyLm9mZignZm9jdXMuc2xpY2sgYmx1ci5zbGljaycpOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuYXJyb3dzID09PSB0cnVlICYmIF8uc2xpZGVDb3VudCA+IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCiAgICAgICAgICAgIF8uJHByZXZBcnJvdyAmJiBfLiRwcmV2QXJyb3cub2ZmKCdjbGljay5zbGljaycsIF8uY2hhbmdlU2xpZGUpOw0KICAgICAgICAgICAgXy4kbmV4dEFycm93ICYmIF8uJG5leHRBcnJvdy5vZmYoJ2NsaWNrLnNsaWNrJywgXy5jaGFuZ2VTbGlkZSk7DQogICAgICAgIH0NCg0KICAgICAgICBfLiRsaXN0Lm9mZigndG91Y2hzdGFydC5zbGljayBtb3VzZWRvd24uc2xpY2snLCBfLnN3aXBlSGFuZGxlcik7DQogICAgICAgIF8uJGxpc3Qub2ZmKCd0b3VjaG1vdmUuc2xpY2sgbW91c2Vtb3ZlLnNsaWNrJywgXy5zd2lwZUhhbmRsZXIpOw0KICAgICAgICBfLiRsaXN0Lm9mZigndG91Y2hlbmQuc2xpY2sgbW91c2V1cC5zbGljaycsIF8uc3dpcGVIYW5kbGVyKTsNCiAgICAgICAgXy4kbGlzdC5vZmYoJ3RvdWNoY2FuY2VsLnNsaWNrIG1vdXNlbGVhdmUuc2xpY2snLCBfLnN3aXBlSGFuZGxlcik7DQoNCiAgICAgICAgXy4kbGlzdC5vZmYoJ2NsaWNrLnNsaWNrJywgXy5jbGlja0hhbmRsZXIpOw0KDQogICAgICAgICQoZG9jdW1lbnQpLm9mZihfLnZpc2liaWxpdHlDaGFuZ2UsIF8udmlzaWJpbGl0eSk7DQoNCiAgICAgICAgXy5jbGVhblVwU2xpZGVFdmVudHMoKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmFjY2Vzc2liaWxpdHkgPT09IHRydWUpIHsNCiAgICAgICAgICAgIF8uJGxpc3Qub2ZmKCdrZXlkb3duLnNsaWNrJywgXy5rZXlIYW5kbGVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuZm9jdXNPblNlbGVjdCA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgJChfLiRzbGlkZVRyYWNrKS5jaGlsZHJlbigpLm9mZignY2xpY2suc2xpY2snLCBfLnNlbGVjdEhhbmRsZXIpOw0KICAgICAgICB9DQoNCiAgICAgICAgJCh3aW5kb3cpLm9mZignb3JpZW50YXRpb25jaGFuZ2Uuc2xpY2suc2xpY2stJyArIF8uaW5zdGFuY2VVaWQsIF8ub3JpZW50YXRpb25DaGFuZ2UpOw0KDQogICAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZS5zbGljay5zbGljay0nICsgXy5pbnN0YW5jZVVpZCwgXy5yZXNpemUpOw0KDQogICAgICAgICQoJ1tkcmFnZ2FibGUhPXRydWVdJywgXy4kc2xpZGVUcmFjaykub2ZmKCdkcmFnc3RhcnQnLCBfLnByZXZlbnREZWZhdWx0KTsNCg0KICAgICAgICAkKHdpbmRvdykub2ZmKCdsb2FkLnNsaWNrLnNsaWNrLScgKyBfLmluc3RhbmNlVWlkLCBfLnNldFBvc2l0aW9uKTsNCiAgICAgICAgJChkb2N1bWVudCkub2ZmKCdyZWFkeS5zbGljay5zbGljay0nICsgXy5pbnN0YW5jZVVpZCwgXy5zZXRQb3NpdGlvbik7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmNsZWFuVXBTbGlkZUV2ZW50cyA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy4kbGlzdC5vZmYoJ21vdXNlZW50ZXIuc2xpY2snLCAkLnByb3h5KF8uaW50ZXJydXB0LCBfLCB0cnVlKSk7DQogICAgICAgIF8uJGxpc3Qub2ZmKCdtb3VzZWxlYXZlLnNsaWNrJywgJC5wcm94eShfLmludGVycnVwdCwgXywgZmFsc2UpKTsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuY2xlYW5VcFJvd3MgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLCBvcmlnaW5hbFNsaWRlczsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLnJvd3MgPiAxKSB7DQogICAgICAgICAgICBvcmlnaW5hbFNsaWRlcyA9IF8uJHNsaWRlcy5jaGlsZHJlbigpLmNoaWxkcmVuKCk7DQogICAgICAgICAgICBvcmlnaW5hbFNsaWRlcy5yZW1vdmVBdHRyKCdzdHlsZScpOw0KICAgICAgICAgICAgXy4kc2xpZGVyLmVtcHR5KCkuYXBwZW5kKG9yaWdpbmFsU2xpZGVzKTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5jbGlja0hhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKF8uc2hvdWxkQ2xpY2sgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsNCiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOw0KICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKHJlZnJlc2gpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy5hdXRvUGxheUNsZWFyKCk7DQoNCiAgICAgICAgXy50b3VjaE9iamVjdCA9IHt9Ow0KDQogICAgICAgIF8uY2xlYW5VcEV2ZW50cygpOw0KDQogICAgICAgICQoJy5zbGljay1jbG9uZWQnLCBfLiRzbGlkZXIpLmRldGFjaCgpOw0KDQogICAgICAgIGlmIChfLiRkb3RzKSB7DQogICAgICAgICAgICBfLiRkb3RzLnJlbW92ZSgpOw0KICAgICAgICB9DQoNCg0KICAgICAgICBpZiAoXy4kcHJldkFycm93ICYmIF8uJHByZXZBcnJvdy5sZW5ndGgpIHsNCg0KICAgICAgICAgICAgXy4kcHJldkFycm93DQogICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdzbGljay1kaXNhYmxlZCBzbGljay1hcnJvdyBzbGljay1oaWRkZW4nKQ0KICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdhcmlhLWhpZGRlbiBhcmlhLWRpc2FibGVkIHRhYmluZGV4JykNCiAgICAgICAgICAgICAgICAuY3NzKCdkaXNwbGF5JywgJycpOw0KDQogICAgICAgICAgICBpZiAoXy5odG1sRXhwci50ZXN0KF8ub3B0aW9ucy5wcmV2QXJyb3cpKSB7DQogICAgICAgICAgICAgICAgXy4kcHJldkFycm93LnJlbW92ZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8uJG5leHRBcnJvdyAmJiBfLiRuZXh0QXJyb3cubGVuZ3RoKSB7DQoNCiAgICAgICAgICAgIF8uJG5leHRBcnJvdw0KICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnc2xpY2stZGlzYWJsZWQgc2xpY2stYXJyb3cgc2xpY2staGlkZGVuJykNCiAgICAgICAgICAgICAgICAucmVtb3ZlQXR0cignYXJpYS1oaWRkZW4gYXJpYS1kaXNhYmxlZCB0YWJpbmRleCcpDQogICAgICAgICAgICAgICAgLmNzcygnZGlzcGxheScsICcnKTsNCg0KICAgICAgICAgICAgaWYgKF8uaHRtbEV4cHIudGVzdChfLm9wdGlvbnMubmV4dEFycm93KSkgew0KICAgICAgICAgICAgICAgIF8uJG5leHRBcnJvdy5yZW1vdmUoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCg0KICAgICAgICBpZiAoXy4kc2xpZGVzKSB7DQoNCiAgICAgICAgICAgIF8uJHNsaWRlcw0KICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnc2xpY2stc2xpZGUgc2xpY2stYWN0aXZlIHNsaWNrLWNlbnRlciBzbGljay12aXNpYmxlIHNsaWNrLWN1cnJlbnQnKQ0KICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdhcmlhLWhpZGRlbicpDQogICAgICAgICAgICAgICAgLnJlbW92ZUF0dHIoJ2RhdGEtc2xpY2staW5kZXgnKQ0KICAgICAgICAgICAgICAgIC5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCdzdHlsZScsICQodGhpcykuZGF0YSgnb3JpZ2luYWxTdHlsaW5nJykpOw0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5zbGlkZSkuZGV0YWNoKCk7DQoNCiAgICAgICAgICAgIF8uJHNsaWRlVHJhY2suZGV0YWNoKCk7DQoNCiAgICAgICAgICAgIF8uJGxpc3QuZGV0YWNoKCk7DQoNCiAgICAgICAgICAgIF8uJHNsaWRlci5hcHBlbmQoXy4kc2xpZGVzKTsNCiAgICAgICAgfQ0KDQogICAgICAgIF8uY2xlYW5VcFJvd3MoKTsNCg0KICAgICAgICBfLiRzbGlkZXIucmVtb3ZlQ2xhc3MoJ3NsaWNrLXNsaWRlcicpOw0KICAgICAgICBfLiRzbGlkZXIucmVtb3ZlQ2xhc3MoJ3NsaWNrLWluaXRpYWxpemVkJyk7DQogICAgICAgIF8uJHNsaWRlci5yZW1vdmVDbGFzcygnc2xpY2stZG90dGVkJyk7DQoNCiAgICAgICAgXy51bnNsaWNrZWQgPSB0cnVlOw0KDQogICAgICAgIGlmICghcmVmcmVzaCkgew0KICAgICAgICAgICAgXy4kc2xpZGVyLnRyaWdnZXIoJ2Rlc3Ryb3knLCBbX10pOw0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmRpc2FibGVUcmFuc2l0aW9uID0gZnVuY3Rpb24gKHNsaWRlKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgdHJhbnNpdGlvbiA9IHt9Ow0KDQogICAgICAgIHRyYW5zaXRpb25bXy50cmFuc2l0aW9uVHlwZV0gPSAnJzsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmZhZGUgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNzcyh0cmFuc2l0aW9uKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIF8uJHNsaWRlcy5lcShzbGlkZSkuY3NzKHRyYW5zaXRpb24pOw0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmZhZGVTbGlkZSA9IGZ1bmN0aW9uIChzbGlkZUluZGV4LCBjYWxsYmFjaykgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5jc3NUcmFuc2l0aW9ucyA9PT0gZmFsc2UpIHsNCg0KICAgICAgICAgICAgXy4kc2xpZGVzLmVxKHNsaWRlSW5kZXgpLmNzcyh7DQogICAgICAgICAgICAgICAgekluZGV4OiBfLm9wdGlvbnMuekluZGV4DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgXy4kc2xpZGVzLmVxKHNsaWRlSW5kZXgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgIG9wYWNpdHk6IDENCiAgICAgICAgICAgIH0sIF8ub3B0aW9ucy5zcGVlZCwgXy5vcHRpb25zLmVhc2luZywgY2FsbGJhY2spOw0KDQogICAgICAgIH0gZWxzZSB7DQoNCiAgICAgICAgICAgIF8uYXBwbHlUcmFuc2l0aW9uKHNsaWRlSW5kZXgpOw0KDQogICAgICAgICAgICBfLiRzbGlkZXMuZXEoc2xpZGVJbmRleCkuY3NzKHsNCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLA0KICAgICAgICAgICAgICAgIHpJbmRleDogXy5vcHRpb25zLnpJbmRleA0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgew0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KDQogICAgICAgICAgICAgICAgICAgIF8uZGlzYWJsZVRyYW5zaXRpb24oc2xpZGVJbmRleCk7DQoNCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCgpOw0KICAgICAgICAgICAgICAgIH0sIF8ub3B0aW9ucy5zcGVlZCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5mYWRlU2xpZGVPdXQgPSBmdW5jdGlvbiAoc2xpZGVJbmRleCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5jc3NUcmFuc2l0aW9ucyA9PT0gZmFsc2UpIHsNCg0KICAgICAgICAgICAgXy4kc2xpZGVzLmVxKHNsaWRlSW5kZXgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAsDQogICAgICAgICAgICAgICAgekluZGV4OiBfLm9wdGlvbnMuekluZGV4IC0gMg0KICAgICAgICAgICAgfSwgXy5vcHRpb25zLnNwZWVkLCBfLm9wdGlvbnMuZWFzaW5nKTsNCg0KICAgICAgICB9IGVsc2Ugew0KDQogICAgICAgICAgICBfLmFwcGx5VHJhbnNpdGlvbihzbGlkZUluZGV4KTsNCg0KICAgICAgICAgICAgXy4kc2xpZGVzLmVxKHNsaWRlSW5kZXgpLmNzcyh7DQogICAgICAgICAgICAgICAgb3BhY2l0eTogMCwNCiAgICAgICAgICAgICAgICB6SW5kZXg6IF8ub3B0aW9ucy56SW5kZXggLSAyDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmZpbHRlclNsaWRlcyA9IFNsaWNrLnByb3RvdHlwZS5zbGlja0ZpbHRlciA9IGZ1bmN0aW9uIChmaWx0ZXIpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKGZpbHRlciAhPT0gbnVsbCkgew0KDQogICAgICAgICAgICBfLiRzbGlkZXNDYWNoZSA9IF8uJHNsaWRlczsNCg0KICAgICAgICAgICAgXy51bmxvYWQoKTsNCg0KICAgICAgICAgICAgXy4kc2xpZGVUcmFjay5jaGlsZHJlbih0aGlzLm9wdGlvbnMuc2xpZGUpLmRldGFjaCgpOw0KDQogICAgICAgICAgICBfLiRzbGlkZXNDYWNoZS5maWx0ZXIoZmlsdGVyKS5hcHBlbmRUbyhfLiRzbGlkZVRyYWNrKTsNCg0KICAgICAgICAgICAgXy5yZWluaXQoKTsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmZvY3VzSGFuZGxlciA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy4kc2xpZGVyDQogICAgICAgICAgICAub2ZmKCdmb2N1cy5zbGljayBibHVyLnNsaWNrJykNCiAgICAgICAgICAgIC5vbignZm9jdXMuc2xpY2sgYmx1ci5zbGljaycsDQogICAgICAgICAgICAgICAgJyo6bm90KC5zbGljay1hcnJvdyknLCBmdW5jdGlvbiAoZXZlbnQpIHsNCg0KICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsNCiAgICAgICAgICAgICAgICAgICAgdmFyICRzZiA9ICQodGhpcyk7DQoNCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfLm9wdGlvbnMucGF1c2VPbkZvY3VzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5mb2N1c3NlZCA9ICRzZi5pcygnOmZvY3VzJyk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5hdXRvUGxheSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIH0sIDApOw0KDQogICAgICAgICAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5nZXRDdXJyZW50ID0gU2xpY2sucHJvdG90eXBlLnNsaWNrQ3VycmVudFNsaWRlID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCiAgICAgICAgcmV0dXJuIF8uY3VycmVudFNsaWRlOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5nZXREb3RDb3VudCA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgdmFyIGJyZWFrUG9pbnQgPSAwOw0KICAgICAgICB2YXIgY291bnRlciA9IDA7DQogICAgICAgIHZhciBwYWdlclF0eSA9IDA7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgd2hpbGUgKGJyZWFrUG9pbnQgPCBfLnNsaWRlQ291bnQpIHsNCiAgICAgICAgICAgICAgICArK3BhZ2VyUXR5Ow0KICAgICAgICAgICAgICAgIGJyZWFrUG9pbnQgPSBjb3VudGVyICsgXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsOw0KICAgICAgICAgICAgICAgIGNvdW50ZXIgKz0gXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsIDw9IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgPyBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwgOiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9IGVsc2UgaWYgKF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSB0cnVlKSB7DQogICAgICAgICAgICBwYWdlclF0eSA9IF8uc2xpZGVDb3VudDsNCiAgICAgICAgfSBlbHNlIGlmICghXy5vcHRpb25zLmFzTmF2Rm9yKSB7DQogICAgICAgICAgICBwYWdlclF0eSA9IDEgKyBNYXRoLmNlaWwoKF8uc2xpZGVDb3VudCAtIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIC8gXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHdoaWxlIChicmVha1BvaW50IDwgXy5zbGlkZUNvdW50KSB7DQogICAgICAgICAgICAgICAgKytwYWdlclF0eTsNCiAgICAgICAgICAgICAgICBicmVha1BvaW50ID0gY291bnRlciArIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbDsNCiAgICAgICAgICAgICAgICBjb3VudGVyICs9IF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCA8PSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93ID8gXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsIDogXy5vcHRpb25zLnNsaWRlc1RvU2hvdzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBwYWdlclF0eSAtIDE7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmdldExlZnQgPSBmdW5jdGlvbiAoc2xpZGVJbmRleCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIHRhcmdldExlZnQsDQogICAgICAgICAgICB2ZXJ0aWNhbEhlaWdodCwNCiAgICAgICAgICAgIHZlcnRpY2FsT2Zmc2V0ID0gMCwNCiAgICAgICAgICAgIHRhcmdldFNsaWRlOw0KDQogICAgICAgIF8uc2xpZGVPZmZzZXQgPSAwOw0KICAgICAgICB2ZXJ0aWNhbEhlaWdodCA9IF8uJHNsaWRlcy5maXJzdCgpLm91dGVySGVpZ2h0KHRydWUpOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuaW5maW5pdGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgIGlmIChfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQogICAgICAgICAgICAgICAgXy5zbGlkZU9mZnNldCA9IChfLnNsaWRlV2lkdGggKiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSAqIC0xOw0KICAgICAgICAgICAgICAgIHZlcnRpY2FsT2Zmc2V0ID0gKHZlcnRpY2FsSGVpZ2h0ICogXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgKiAtMTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChfLnNsaWRlQ291bnQgJSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwgIT09IDApIHsNCiAgICAgICAgICAgICAgICBpZiAoc2xpZGVJbmRleCArIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCA+IF8uc2xpZGVDb3VudCAmJiBfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChzbGlkZUluZGV4ID4gXy5zbGlkZUNvdW50KSB7DQogICAgICAgICAgICAgICAgICAgICAgICBfLnNsaWRlT2Zmc2V0ID0gKChfLm9wdGlvbnMuc2xpZGVzVG9TaG93IC0gKHNsaWRlSW5kZXggLSBfLnNsaWRlQ291bnQpKSAqIF8uc2xpZGVXaWR0aCkgKiAtMTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZlcnRpY2FsT2Zmc2V0ID0gKChfLm9wdGlvbnMuc2xpZGVzVG9TaG93IC0gKHNsaWRlSW5kZXggLSBfLnNsaWRlQ291bnQpKSAqIHZlcnRpY2FsSGVpZ2h0KSAqIC0xOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgXy5zbGlkZU9mZnNldCA9ICgoXy5zbGlkZUNvdW50ICUgXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsKSAqIF8uc2xpZGVXaWR0aCkgKiAtMTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZlcnRpY2FsT2Zmc2V0ID0gKChfLnNsaWRlQ291bnQgJSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwpICogdmVydGljYWxIZWlnaHQpICogLTE7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpZiAoc2xpZGVJbmRleCArIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgPiBfLnNsaWRlQ291bnQpIHsNCiAgICAgICAgICAgICAgICBfLnNsaWRlT2Zmc2V0ID0gKChzbGlkZUluZGV4ICsgXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgLSBfLnNsaWRlQ291bnQpICogXy5zbGlkZVdpZHRoOw0KICAgICAgICAgICAgICAgIHZlcnRpY2FsT2Zmc2V0ID0gKChzbGlkZUluZGV4ICsgXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgLSBfLnNsaWRlQ291bnQpICogdmVydGljYWxIZWlnaHQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5zbGlkZUNvdW50IDw9IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCiAgICAgICAgICAgIF8uc2xpZGVPZmZzZXQgPSAwOw0KICAgICAgICAgICAgdmVydGljYWxPZmZzZXQgPSAwOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSB0cnVlICYmIF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy5zbGlkZU9mZnNldCArPSBfLnNsaWRlV2lkdGggKiBNYXRoLmZsb29yKF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgLyAyKSAtIF8uc2xpZGVXaWR0aDsNCiAgICAgICAgfSBlbHNlIGlmIChfLm9wdGlvbnMuY2VudGVyTW9kZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy5zbGlkZU9mZnNldCA9IDA7DQogICAgICAgICAgICBfLnNsaWRlT2Zmc2V0ICs9IF8uc2xpZGVXaWR0aCAqIE1hdGguZmxvb3IoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyAvIDIpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy52ZXJ0aWNhbCA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHRhcmdldExlZnQgPSAoKHNsaWRlSW5kZXggKiBfLnNsaWRlV2lkdGgpICogLTEpICsgXy5zbGlkZU9mZnNldDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHRhcmdldExlZnQgPSAoKHNsaWRlSW5kZXggKiB2ZXJ0aWNhbEhlaWdodCkgKiAtMSkgKyB2ZXJ0aWNhbE9mZnNldDsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMudmFyaWFibGVXaWR0aCA9PT0gdHJ1ZSkgew0KDQogICAgICAgICAgICBpZiAoXy5zbGlkZUNvdW50IDw9IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgfHwgXy5vcHRpb25zLmluZmluaXRlID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIHRhcmdldFNsaWRlID0gXy4kc2xpZGVUcmFjay5jaGlsZHJlbignLnNsaWNrLXNsaWRlJykuZXEoc2xpZGVJbmRleCk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHRhcmdldFNsaWRlID0gXy4kc2xpZGVUcmFjay5jaGlsZHJlbignLnNsaWNrLXNsaWRlJykuZXEoc2xpZGVJbmRleCArIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAoXy5vcHRpb25zLnJ0bCA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgIGlmICh0YXJnZXRTbGlkZVswXSkgew0KICAgICAgICAgICAgICAgICAgICB0YXJnZXRMZWZ0ID0gKF8uJHNsaWRlVHJhY2sud2lkdGgoKSAtIHRhcmdldFNsaWRlWzBdLm9mZnNldExlZnQgLSB0YXJnZXRTbGlkZS53aWR0aCgpKSAqIC0xOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHRhcmdldExlZnQgPSAwOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgdGFyZ2V0TGVmdCA9IHRhcmdldFNsaWRlWzBdID8gdGFyZ2V0U2xpZGVbMF0ub2Zmc2V0TGVmdCAqIC0xIDogMDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSB0cnVlKSB7DQogICAgICAgICAgICAgICAgaWYgKF8uc2xpZGVDb3VudCA8PSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93IHx8IF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2xpZGUgPSBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKCcuc2xpY2stc2xpZGUnKS5lcShzbGlkZUluZGV4KTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0YXJnZXRTbGlkZSA9IF8uJHNsaWRlVHJhY2suY2hpbGRyZW4oJy5zbGljay1zbGlkZScpLmVxKHNsaWRlSW5kZXggKyBfLm9wdGlvbnMuc2xpZGVzVG9TaG93ICsgMSk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5ydGwgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFNsaWRlWzBdKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRMZWZ0ID0gKF8uJHNsaWRlVHJhY2sud2lkdGgoKSAtIHRhcmdldFNsaWRlWzBdLm9mZnNldExlZnQgLSB0YXJnZXRTbGlkZS53aWR0aCgpKSAqIC0xOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0TGVmdCA9IDA7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0YXJnZXRMZWZ0ID0gdGFyZ2V0U2xpZGVbMF0gPyB0YXJnZXRTbGlkZVswXS5vZmZzZXRMZWZ0ICogLTEgOiAwOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHRhcmdldExlZnQgKz0gKF8uJGxpc3Qud2lkdGgoKSAtIHRhcmdldFNsaWRlLm91dGVyV2lkdGgoKSkgLyAyOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHRhcmdldExlZnQ7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmdldE9wdGlvbiA9IFNsaWNrLnByb3RvdHlwZS5zbGlja0dldE9wdGlvbiA9IGZ1bmN0aW9uIChvcHRpb24pIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgcmV0dXJuIF8ub3B0aW9uc1tvcHRpb25dOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5nZXROYXZpZ2FibGVJbmRleGVzID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIGJyZWFrUG9pbnQgPSAwLA0KICAgICAgICAgICAgY291bnRlciA9IDAsDQogICAgICAgICAgICBpbmRleGVzID0gW10sDQogICAgICAgICAgICBtYXg7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIG1heCA9IF8uc2xpZGVDb3VudDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGJyZWFrUG9pbnQgPSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwgKiAtMTsNCiAgICAgICAgICAgIGNvdW50ZXIgPSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwgKiAtMTsNCiAgICAgICAgICAgIG1heCA9IF8uc2xpZGVDb3VudCAqIDI7DQogICAgICAgIH0NCg0KICAgICAgICB3aGlsZSAoYnJlYWtQb2ludCA8IG1heCkgew0KICAgICAgICAgICAgaW5kZXhlcy5wdXNoKGJyZWFrUG9pbnQpOw0KICAgICAgICAgICAgYnJlYWtQb2ludCA9IGNvdW50ZXIgKyBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGw7DQogICAgICAgICAgICBjb3VudGVyICs9IF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCA8PSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93ID8gXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsIDogXy5vcHRpb25zLnNsaWRlc1RvU2hvdzsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBpbmRleGVzOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5nZXRTbGljayA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICByZXR1cm4gdGhpczsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuZ2V0U2xpZGVDb3VudCA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXMsDQogICAgICAgICAgICBzbGlkZXNUcmF2ZXJzZWQsIHN3aXBlZFNsaWRlLCBjZW50ZXJPZmZzZXQ7DQoNCiAgICAgICAgY2VudGVyT2Zmc2V0ID0gXy5vcHRpb25zLmNlbnRlck1vZGUgPT09IHRydWUgPyBfLnNsaWRlV2lkdGggKiBNYXRoLmZsb29yKF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgLyAyKSA6IDA7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5zd2lwZVRvU2xpZGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgIF8uJHNsaWRlVHJhY2suZmluZCgnLnNsaWNrLXNsaWRlJykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIHNsaWRlKSB7DQogICAgICAgICAgICAgICAgaWYgKHNsaWRlLm9mZnNldExlZnQgLSBjZW50ZXJPZmZzZXQgKyAoJChzbGlkZSkub3V0ZXJXaWR0aCgpIC8gMikgPiAoXy5zd2lwZUxlZnQgKiAtMSkpIHsNCiAgICAgICAgICAgICAgICAgICAgc3dpcGVkU2xpZGUgPSBzbGlkZTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBzbGlkZXNUcmF2ZXJzZWQgPSBNYXRoLmFicygkKHN3aXBlZFNsaWRlKS5hdHRyKCdkYXRhLXNsaWNrLWluZGV4JykgLSBfLmN1cnJlbnRTbGlkZSkgfHwgMTsNCg0KICAgICAgICAgICAgcmV0dXJuIHNsaWRlc1RyYXZlcnNlZDsNCg0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbDsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5nb1RvID0gU2xpY2sucHJvdG90eXBlLnNsaWNrR29UbyA9IGZ1bmN0aW9uIChzbGlkZSwgZG9udEFuaW1hdGUpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy5jaGFuZ2VTbGlkZSh7DQogICAgICAgICAgICBkYXRhOiB7DQogICAgICAgICAgICAgICAgbWVzc2FnZTogJ2luZGV4JywNCiAgICAgICAgICAgICAgICBpbmRleDogcGFyc2VJbnQoc2xpZGUpDQogICAgICAgICAgICB9DQogICAgICAgIH0sIGRvbnRBbmltYXRlKTsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChjcmVhdGlvbikgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoISQoXy4kc2xpZGVyKS5oYXNDbGFzcygnc2xpY2staW5pdGlhbGl6ZWQnKSkgew0KDQogICAgICAgICAgICAkKF8uJHNsaWRlcikuYWRkQ2xhc3MoJ3NsaWNrLWluaXRpYWxpemVkJyk7DQoNCiAgICAgICAgICAgIF8uYnVpbGRSb3dzKCk7DQogICAgICAgICAgICBfLmJ1aWxkT3V0KCk7DQogICAgICAgICAgICBfLnNldFByb3BzKCk7DQogICAgICAgICAgICBfLnN0YXJ0TG9hZCgpOw0KICAgICAgICAgICAgXy5sb2FkU2xpZGVyKCk7DQogICAgICAgICAgICBfLmluaXRpYWxpemVFdmVudHMoKTsNCiAgICAgICAgICAgIF8udXBkYXRlQXJyb3dzKCk7DQogICAgICAgICAgICBfLnVwZGF0ZURvdHMoKTsNCiAgICAgICAgICAgIF8uY2hlY2tSZXNwb25zaXZlKHRydWUpOw0KICAgICAgICAgICAgXy5mb2N1c0hhbmRsZXIoKTsNCg0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKGNyZWF0aW9uKSB7DQogICAgICAgICAgICBfLiRzbGlkZXIudHJpZ2dlcignaW5pdCcsIFtfXSk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmFjY2Vzc2liaWxpdHkgPT09IHRydWUpIHsNCiAgICAgICAgICAgIF8uaW5pdEFEQSgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5hdXRvcGxheSkgew0KDQogICAgICAgICAgICBfLnBhdXNlZCA9IGZhbHNlOw0KICAgICAgICAgICAgXy5hdXRvUGxheSgpOw0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuaW5pdEFEQSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KICAgICAgICBfLiRzbGlkZXMuYWRkKF8uJHNsaWRlVHJhY2suZmluZCgnLnNsaWNrLWNsb25lZCcpKS5hdHRyKHsNCiAgICAgICAgICAgICdhcmlhLWhpZGRlbic6ICd0cnVlJywNCiAgICAgICAgICAgICd0YWJpbmRleCc6ICctMScNCiAgICAgICAgfSkuZmluZCgnYSwgaW5wdXQsIGJ1dHRvbiwgc2VsZWN0JykuYXR0cih7DQogICAgICAgICAgICAndGFiaW5kZXgnOiAnLTEnDQogICAgICAgIH0pOw0KDQogICAgICAgIF8uJHNsaWRlVHJhY2suYXR0cigncm9sZScsICdsaXN0Ym94Jyk7DQoNCiAgICAgICAgXy4kc2xpZGVzLm5vdChfLiRzbGlkZVRyYWNrLmZpbmQoJy5zbGljay1jbG9uZWQnKSkuZWFjaChmdW5jdGlvbiAoaSkgew0KICAgICAgICAgICAgJCh0aGlzKS5hdHRyKHsNCiAgICAgICAgICAgICAgICAncm9sZSc6ICdvcHRpb24nLA0KICAgICAgICAgICAgICAgICdhcmlhLWRlc2NyaWJlZGJ5JzogJ3NsaWNrLXNsaWRlJyArIF8uaW5zdGFuY2VVaWQgKyBpICsgJycNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCg0KICAgICAgICBpZiAoXy4kZG90cyAhPT0gbnVsbCkgew0KICAgICAgICAgICAgXy4kZG90cy5hdHRyKCdyb2xlJywgJ3RhYmxpc3QnKS5maW5kKCdsaScpLmVhY2goZnVuY3Rpb24gKGkpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmF0dHIoew0KICAgICAgICAgICAgICAgICAgICAncm9sZSc6ICdwcmVzZW50YXRpb24nLA0KICAgICAgICAgICAgICAgICAgICAnYXJpYS1zZWxlY3RlZCc6ICdmYWxzZScsDQogICAgICAgICAgICAgICAgICAgICdhcmlhLWNvbnRyb2xzJzogJ25hdmlnYXRpb24nICsgXy5pbnN0YW5jZVVpZCArIGkgKyAnJywNCiAgICAgICAgICAgICAgICAgICAgJ2lkJzogJ3NsaWNrLXNsaWRlJyArIF8uaW5zdGFuY2VVaWQgKyBpICsgJycNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pDQogICAgICAgICAgICAgICAgLmZpcnN0KCkuYXR0cignYXJpYS1zZWxlY3RlZCcsICd0cnVlJykuZW5kKCkNCiAgICAgICAgICAgICAgICAuZmluZCgnYnV0dG9uJykuYXR0cigncm9sZScsICdidXR0b24nKS5lbmQoKQ0KICAgICAgICAgICAgICAgIC5jbG9zZXN0KCdkaXYnKS5hdHRyKCdyb2xlJywgJ3Rvb2xiYXInKTsNCiAgICAgICAgfQ0KICAgICAgICBfLmFjdGl2YXRlQURBKCk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmluaXRBcnJvd0V2ZW50cyA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5hcnJvd3MgPT09IHRydWUgJiYgXy5zbGlkZUNvdW50ID4gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KICAgICAgICAgICAgXy4kcHJldkFycm93DQogICAgICAgICAgICAgICAgLm9mZignY2xpY2suc2xpY2snKQ0KICAgICAgICAgICAgICAgIC5vbignY2xpY2suc2xpY2snLCB7DQogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdwcmV2aW91cycNCiAgICAgICAgICAgICAgICB9LCBfLmNoYW5nZVNsaWRlKTsNCiAgICAgICAgICAgIF8uJG5leHRBcnJvdw0KICAgICAgICAgICAgICAgIC5vZmYoJ2NsaWNrLnNsaWNrJykNCiAgICAgICAgICAgICAgICAub24oJ2NsaWNrLnNsaWNrJywgew0KICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnbmV4dCcNCiAgICAgICAgICAgICAgICB9LCBfLmNoYW5nZVNsaWRlKTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5pbml0RG90RXZlbnRzID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmRvdHMgPT09IHRydWUgJiYgXy5zbGlkZUNvdW50ID4gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KICAgICAgICAgICAgJCgnbGknLCBfLiRkb3RzKS5vbignY2xpY2suc2xpY2snLCB7DQogICAgICAgICAgICAgICAgbWVzc2FnZTogJ2luZGV4Jw0KICAgICAgICAgICAgfSwgXy5jaGFuZ2VTbGlkZSk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmRvdHMgPT09IHRydWUgJiYgXy5vcHRpb25zLnBhdXNlT25Eb3RzSG92ZXIgPT09IHRydWUpIHsNCg0KICAgICAgICAgICAgJCgnbGknLCBfLiRkb3RzKQ0KICAgICAgICAgICAgICAgIC5vbignbW91c2VlbnRlci5zbGljaycsICQucHJveHkoXy5pbnRlcnJ1cHQsIF8sIHRydWUpKQ0KICAgICAgICAgICAgICAgIC5vbignbW91c2VsZWF2ZS5zbGljaycsICQucHJveHkoXy5pbnRlcnJ1cHQsIF8sIGZhbHNlKSk7DQoNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5pbml0U2xpZGVFdmVudHMgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMucGF1c2VPbkhvdmVyKSB7DQoNCiAgICAgICAgICAgIF8uJGxpc3Qub24oJ21vdXNlZW50ZXIuc2xpY2snLCAkLnByb3h5KF8uaW50ZXJydXB0LCBfLCB0cnVlKSk7DQogICAgICAgICAgICBfLiRsaXN0Lm9uKCdtb3VzZWxlYXZlLnNsaWNrJywgJC5wcm94eShfLmludGVycnVwdCwgXywgZmFsc2UpKTsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmluaXRpYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIF8uaW5pdEFycm93RXZlbnRzKCk7DQoNCiAgICAgICAgXy5pbml0RG90RXZlbnRzKCk7DQogICAgICAgIF8uaW5pdFNsaWRlRXZlbnRzKCk7DQoNCiAgICAgICAgXy4kbGlzdC5vbigndG91Y2hzdGFydC5zbGljayBtb3VzZWRvd24uc2xpY2snLCB7DQogICAgICAgICAgICBhY3Rpb246ICdzdGFydCcNCiAgICAgICAgfSwgXy5zd2lwZUhhbmRsZXIpOw0KICAgICAgICBfLiRsaXN0Lm9uKCd0b3VjaG1vdmUuc2xpY2sgbW91c2Vtb3ZlLnNsaWNrJywgew0KICAgICAgICAgICAgYWN0aW9uOiAnbW92ZScNCiAgICAgICAgfSwgXy5zd2lwZUhhbmRsZXIpOw0KICAgICAgICBfLiRsaXN0Lm9uKCd0b3VjaGVuZC5zbGljayBtb3VzZXVwLnNsaWNrJywgew0KICAgICAgICAgICAgYWN0aW9uOiAnZW5kJw0KICAgICAgICB9LCBfLnN3aXBlSGFuZGxlcik7DQogICAgICAgIF8uJGxpc3Qub24oJ3RvdWNoY2FuY2VsLnNsaWNrIG1vdXNlbGVhdmUuc2xpY2snLCB7DQogICAgICAgICAgICBhY3Rpb246ICdlbmQnDQogICAgICAgIH0sIF8uc3dpcGVIYW5kbGVyKTsNCg0KICAgICAgICBfLiRsaXN0Lm9uKCdjbGljay5zbGljaycsIF8uY2xpY2tIYW5kbGVyKTsNCg0KICAgICAgICAkKGRvY3VtZW50KS5vbihfLnZpc2liaWxpdHlDaGFuZ2UsICQucHJveHkoXy52aXNpYmlsaXR5LCBfKSk7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5hY2Nlc3NpYmlsaXR5ID09PSB0cnVlKSB7DQogICAgICAgICAgICBfLiRsaXN0Lm9uKCdrZXlkb3duLnNsaWNrJywgXy5rZXlIYW5kbGVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuZm9jdXNPblNlbGVjdCA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgJChfLiRzbGlkZVRyYWNrKS5jaGlsZHJlbigpLm9uKCdjbGljay5zbGljaycsIF8uc2VsZWN0SGFuZGxlcik7DQogICAgICAgIH0NCg0KICAgICAgICAkKHdpbmRvdykub24oJ29yaWVudGF0aW9uY2hhbmdlLnNsaWNrLnNsaWNrLScgKyBfLmluc3RhbmNlVWlkLCAkLnByb3h5KF8ub3JpZW50YXRpb25DaGFuZ2UsIF8pKTsNCg0KICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZS5zbGljay5zbGljay0nICsgXy5pbnN0YW5jZVVpZCwgJC5wcm94eShfLnJlc2l6ZSwgXykpOw0KDQogICAgICAgICQoJ1tkcmFnZ2FibGUhPXRydWVdJywgXy4kc2xpZGVUcmFjaykub24oJ2RyYWdzdGFydCcsIF8ucHJldmVudERlZmF1bHQpOw0KDQogICAgICAgICQod2luZG93KS5vbignbG9hZC5zbGljay5zbGljay0nICsgXy5pbnN0YW5jZVVpZCwgXy5zZXRQb3NpdGlvbik7DQogICAgICAgICQoZG9jdW1lbnQpLm9uKCdyZWFkeS5zbGljay5zbGljay0nICsgXy5pbnN0YW5jZVVpZCwgXy5zZXRQb3NpdGlvbik7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmluaXRVSSA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5hcnJvd3MgPT09IHRydWUgJiYgXy5zbGlkZUNvdW50ID4gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KDQogICAgICAgICAgICBfLiRwcmV2QXJyb3cuc2hvdygpOw0KICAgICAgICAgICAgXy4kbmV4dEFycm93LnNob3coKTsNCg0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5kb3RzID09PSB0cnVlICYmIF8uc2xpZGVDb3VudCA+IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCg0KICAgICAgICAgICAgXy4kZG90cy5zaG93KCk7DQoNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5rZXlIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KICAgICAgICAvL0RvbnQgc2xpZGUgaWYgdGhlIGN1cnNvciBpcyBpbnNpZGUgdGhlIGZvcm0gZmllbGRzIGFuZCBhcnJvdyBrZXlzIGFyZSBwcmVzc2VkDQogICAgICAgIGlmICghZXZlbnQudGFyZ2V0LnRhZ05hbWUubWF0Y2goJ1RFWFRBUkVBfElOUFVUfFNFTEVDVCcpKSB7DQogICAgICAgICAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gMzcgJiYgXy5vcHRpb25zLmFjY2Vzc2liaWxpdHkgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICBfLmNoYW5nZVNsaWRlKHsNCiAgICAgICAgICAgICAgICAgICAgZGF0YTogew0KICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogXy5vcHRpb25zLnJ0bCA9PT0gdHJ1ZSA/ICduZXh0JyA6ICdwcmV2aW91cycNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5rZXlDb2RlID09PSAzOSAmJiBfLm9wdGlvbnMuYWNjZXNzaWJpbGl0eSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgIF8uY2hhbmdlU2xpZGUoew0KICAgICAgICAgICAgICAgICAgICBkYXRhOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBfLm9wdGlvbnMucnRsID09PSB0cnVlID8gJ3ByZXZpb3VzJyA6ICduZXh0Jw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUubGF6eUxvYWQgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgbG9hZFJhbmdlLCBjbG9uZVJhbmdlLCByYW5nZVN0YXJ0LCByYW5nZUVuZDsNCg0KICAgICAgICBmdW5jdGlvbiBsb2FkSW1hZ2VzKGltYWdlc1Njb3BlKSB7DQoNCiAgICAgICAgICAgICQoJ2ltZ1tkYXRhLWxhenldJywgaW1hZ2VzU2NvcGUpLmVhY2goZnVuY3Rpb24gKCkgew0KDQogICAgICAgICAgICAgICAgdmFyIGltYWdlID0gJCh0aGlzKSwNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2VTb3VyY2UgPSAkKHRoaXMpLmF0dHIoJ2RhdGEtbGF6eScpLA0KICAgICAgICAgICAgICAgICAgICBpbWFnZVRvTG9hZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOw0KDQogICAgICAgICAgICAgICAgaW1hZ2VUb0xvYWQub25sb2FkID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgICAgICAgICAgICAgIGltYWdlDQogICAgICAgICAgICAgICAgICAgICAgICAuYW5pbWF0ZSh7IG9wYWNpdHk6IDAgfSwgMTAwLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ3NyYycsIGltYWdlU291cmNlKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYW5pbWF0ZSh7IG9wYWNpdHk6IDEgfSwgMjAwLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdkYXRhLWxhenknKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnc2xpY2stbG9hZGluZycpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLiRzbGlkZXIudHJpZ2dlcignbGF6eUxvYWRlZCcsIFtfLCBpbWFnZSwgaW1hZ2VTb3VyY2VdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIGltYWdlVG9Mb2FkLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2UNCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdkYXRhLWxhenknKQ0KICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdzbGljay1sb2FkaW5nJykNCiAgICAgICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc2xpY2stbGF6eWxvYWQtZXJyb3InKTsNCg0KICAgICAgICAgICAgICAgICAgICBfLiRzbGlkZXIudHJpZ2dlcignbGF6eUxvYWRFcnJvcicsIFtfLCBpbWFnZSwgaW1hZ2VTb3VyY2VdKTsNCg0KICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICBpbWFnZVRvTG9hZC5zcmMgPSBpbWFnZVNvdXJjZTsNCg0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuY2VudGVyTW9kZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgIHJhbmdlU3RhcnQgPSBfLmN1cnJlbnRTbGlkZSArIChfLm9wdGlvbnMuc2xpZGVzVG9TaG93IC8gMiArIDEpOw0KICAgICAgICAgICAgICAgIHJhbmdlRW5kID0gcmFuZ2VTdGFydCArIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgKyAyOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICByYW5nZVN0YXJ0ID0gTWF0aC5tYXgoMCwgXy5jdXJyZW50U2xpZGUgLSAoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyAvIDIgKyAxKSk7DQogICAgICAgICAgICAgICAgcmFuZ2VFbmQgPSAyICsgKF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgLyAyICsgMSkgKyBfLmN1cnJlbnRTbGlkZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJhbmdlU3RhcnQgPSBfLm9wdGlvbnMuaW5maW5pdGUgPyBfLm9wdGlvbnMuc2xpZGVzVG9TaG93ICsgXy5jdXJyZW50U2xpZGUgOiBfLmN1cnJlbnRTbGlkZTsNCiAgICAgICAgICAgIHJhbmdlRW5kID0gTWF0aC5jZWlsKHJhbmdlU3RhcnQgKyBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KTsNCiAgICAgICAgICAgIGlmIChfLm9wdGlvbnMuZmFkZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgIGlmIChyYW5nZVN0YXJ0ID4gMCkgcmFuZ2VTdGFydC0tOw0KICAgICAgICAgICAgICAgIGlmIChyYW5nZUVuZCA8PSBfLnNsaWRlQ291bnQpIHJhbmdlRW5kKys7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBsb2FkUmFuZ2UgPSBfLiRzbGlkZXIuZmluZCgnLnNsaWNrLXNsaWRlJykuc2xpY2UocmFuZ2VTdGFydCwgcmFuZ2VFbmQpOw0KICAgICAgICBsb2FkSW1hZ2VzKGxvYWRSYW5nZSk7DQoNCiAgICAgICAgaWYgKF8uc2xpZGVDb3VudCA8PSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQogICAgICAgICAgICBjbG9uZVJhbmdlID0gXy4kc2xpZGVyLmZpbmQoJy5zbGljay1zbGlkZScpOw0KICAgICAgICAgICAgbG9hZEltYWdlcyhjbG9uZVJhbmdlKTsNCiAgICAgICAgfSBlbHNlDQogICAgICAgICAgICBpZiAoXy5jdXJyZW50U2xpZGUgPj0gXy5zbGlkZUNvdW50IC0gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KICAgICAgICAgICAgICAgIGNsb25lUmFuZ2UgPSBfLiRzbGlkZXIuZmluZCgnLnNsaWNrLWNsb25lZCcpLnNsaWNlKDAsIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpOw0KICAgICAgICAgICAgICAgIGxvYWRJbWFnZXMoY2xvbmVSYW5nZSk7DQogICAgICAgICAgICB9IGVsc2UgaWYgKF8uY3VycmVudFNsaWRlID09PSAwKSB7DQogICAgICAgICAgICAgICAgY2xvbmVSYW5nZSA9IF8uJHNsaWRlci5maW5kKCcuc2xpY2stY2xvbmVkJykuc2xpY2UoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyAqIC0xKTsNCiAgICAgICAgICAgICAgICBsb2FkSW1hZ2VzKGNsb25lUmFuZ2UpOw0KICAgICAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5sb2FkU2xpZGVyID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBfLnNldFBvc2l0aW9uKCk7DQoNCiAgICAgICAgXy4kc2xpZGVUcmFjay5jc3Moew0KICAgICAgICAgICAgb3BhY2l0eTogMQ0KICAgICAgICB9KTsNCg0KICAgICAgICBfLiRzbGlkZXIucmVtb3ZlQ2xhc3MoJ3NsaWNrLWxvYWRpbmcnKTsNCg0KICAgICAgICBfLmluaXRVSSgpOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMubGF6eUxvYWQgPT09ICdwcm9ncmVzc2l2ZScpIHsNCiAgICAgICAgICAgIF8ucHJvZ3Jlc3NpdmVMYXp5TG9hZCgpOw0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLm5leHQgPSBTbGljay5wcm90b3R5cGUuc2xpY2tOZXh0ID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBfLmNoYW5nZVNsaWRlKHsNCiAgICAgICAgICAgIGRhdGE6IHsNCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnbmV4dCcNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLm9yaWVudGF0aW9uQ2hhbmdlID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBfLmNoZWNrUmVzcG9uc2l2ZSgpOw0KICAgICAgICBfLnNldFBvc2l0aW9uKCk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnBhdXNlID0gU2xpY2sucHJvdG90eXBlLnNsaWNrUGF1c2UgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIF8uYXV0b1BsYXlDbGVhcigpOw0KICAgICAgICBfLnBhdXNlZCA9IHRydWU7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnBsYXkgPSBTbGljay5wcm90b3R5cGUuc2xpY2tQbGF5ID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBfLmF1dG9QbGF5KCk7DQogICAgICAgIF8ub3B0aW9ucy5hdXRvcGxheSA9IHRydWU7DQogICAgICAgIF8ucGF1c2VkID0gZmFsc2U7DQogICAgICAgIF8uZm9jdXNzZWQgPSBmYWxzZTsNCiAgICAgICAgXy5pbnRlcnJ1cHRlZCA9IGZhbHNlOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5wb3N0U2xpZGUgPSBmdW5jdGlvbiAoaW5kZXgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKCFfLnVuc2xpY2tlZCkgew0KDQogICAgICAgICAgICBfLiRzbGlkZXIudHJpZ2dlcignYWZ0ZXJDaGFuZ2UnLCBbXywgaW5kZXhdKTsNCg0KICAgICAgICAgICAgXy5hbmltYXRpbmcgPSBmYWxzZTsNCg0KICAgICAgICAgICAgXy5zZXRQb3NpdGlvbigpOw0KDQogICAgICAgICAgICBfLnN3aXBlTGVmdCA9IG51bGw7DQoNCiAgICAgICAgICAgIGlmIChfLm9wdGlvbnMuYXV0b3BsYXkpIHsNCiAgICAgICAgICAgICAgICBfLmF1dG9QbGF5KCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChfLm9wdGlvbnMuYWNjZXNzaWJpbGl0eSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgIF8uaW5pdEFEQSgpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUucHJldiA9IFNsaWNrLnByb3RvdHlwZS5zbGlja1ByZXYgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIF8uY2hhbmdlU2xpZGUoew0KICAgICAgICAgICAgZGF0YTogew0KICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdwcmV2aW91cycNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKGV2ZW50KSB7DQoNCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUucHJvZ3Jlc3NpdmVMYXp5TG9hZCA9IGZ1bmN0aW9uICh0cnlDb3VudCkgew0KDQogICAgICAgIHRyeUNvdW50ID0gdHJ5Q291bnQgfHwgMTsNCg0KICAgICAgICB2YXIgXyA9IHRoaXMsDQogICAgICAgICAgICAkaW1nc1RvTG9hZCA9ICQoJ2ltZ1tkYXRhLWxhenldJywgXy4kc2xpZGVyKSwNCiAgICAgICAgICAgIGltYWdlLA0KICAgICAgICAgICAgaW1hZ2VTb3VyY2UsDQogICAgICAgICAgICBpbWFnZVRvTG9hZDsNCg0KICAgICAgICBpZiAoJGltZ3NUb0xvYWQubGVuZ3RoKSB7DQoNCiAgICAgICAgICAgIGltYWdlID0gJGltZ3NUb0xvYWQuZmlyc3QoKTsNCiAgICAgICAgICAgIGltYWdlU291cmNlID0gaW1hZ2UuYXR0cignZGF0YS1sYXp5Jyk7DQogICAgICAgICAgICBpbWFnZVRvTG9hZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOw0KDQogICAgICAgICAgICBpbWFnZVRvTG9hZC5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgICAgICAgICBpbWFnZQ0KICAgICAgICAgICAgICAgICAgICAuYXR0cignc3JjJywgaW1hZ2VTb3VyY2UpDQogICAgICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdkYXRhLWxhenknKQ0KICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3NsaWNrLWxvYWRpbmcnKTsNCg0KICAgICAgICAgICAgICAgIGlmIChfLm9wdGlvbnMuYWRhcHRpdmVIZWlnaHQgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgXy5zZXRQb3NpdGlvbigpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIF8uJHNsaWRlci50cmlnZ2VyKCdsYXp5TG9hZGVkJywgW18sIGltYWdlLCBpbWFnZVNvdXJjZV0pOw0KICAgICAgICAgICAgICAgIF8ucHJvZ3Jlc3NpdmVMYXp5TG9hZCgpOw0KDQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICBpbWFnZVRvTG9hZC5vbmVycm9yID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgICAgICAgICAgaWYgKHRyeUNvdW50IDwgMykgew0KDQogICAgICAgICAgICAgICAgICAgIC8qKg0KICAgICAgICAgICAgICAgICAgICAgKiB0cnkgdG8gbG9hZCB0aGUgaW1hZ2UgMyB0aW1lcywNCiAgICAgICAgICAgICAgICAgICAgICogbGVhdmUgYSBzbGlnaHQgZGVsYXkgc28gd2UgZG9uJ3QgZ2V0DQogICAgICAgICAgICAgICAgICAgICAqIHNlcnZlcnMgYmxvY2tpbmcgdGhlIHJlcXVlc3QuDQogICAgICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIF8ucHJvZ3Jlc3NpdmVMYXp5TG9hZCh0cnlDb3VudCArIDEpOw0KICAgICAgICAgICAgICAgICAgICB9LCA1MDApOw0KDQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCg0KICAgICAgICAgICAgICAgICAgICBpbWFnZQ0KICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUF0dHIoJ2RhdGEtbGF6eScpDQogICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3NsaWNrLWxvYWRpbmcnKQ0KICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdzbGljay1sYXp5bG9hZC1lcnJvcicpOw0KDQogICAgICAgICAgICAgICAgICAgIF8uJHNsaWRlci50cmlnZ2VyKCdsYXp5TG9hZEVycm9yJywgW18sIGltYWdlLCBpbWFnZVNvdXJjZV0pOw0KDQogICAgICAgICAgICAgICAgICAgIF8ucHJvZ3Jlc3NpdmVMYXp5TG9hZCgpOw0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICBpbWFnZVRvTG9hZC5zcmMgPSBpbWFnZVNvdXJjZTsNCg0KICAgICAgICB9IGVsc2Ugew0KDQogICAgICAgICAgICBfLiRzbGlkZXIudHJpZ2dlcignYWxsSW1hZ2VzTG9hZGVkJywgW19dKTsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbiAoaW5pdGlhbGl6aW5nKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLCBjdXJyZW50U2xpZGUsIGxhc3RWaXNpYmxlSW5kZXg7DQoNCiAgICAgICAgbGFzdFZpc2libGVJbmRleCA9IF8uc2xpZGVDb3VudCAtIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3c7DQoNCiAgICAgICAgLy8gaW4gbm9uLWluZmluaXRlIHNsaWRlcnMsIHdlIGRvbid0IHdhbnQgdG8gZ28gcGFzdCB0aGUNCiAgICAgICAgLy8gbGFzdCB2aXNpYmxlIGluZGV4Lg0KICAgICAgICBpZiAoIV8ub3B0aW9ucy5pbmZpbml0ZSAmJiAoXy5jdXJyZW50U2xpZGUgPiBsYXN0VmlzaWJsZUluZGV4KSkgew0KICAgICAgICAgICAgXy5jdXJyZW50U2xpZGUgPSBsYXN0VmlzaWJsZUluZGV4Ow0KICAgICAgICB9DQoNCiAgICAgICAgLy8gaWYgbGVzcyBzbGlkZXMgdGhhbiB0byBzaG93LCBnbyB0byBzdGFydC4NCiAgICAgICAgaWYgKF8uc2xpZGVDb3VudCA8PSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQogICAgICAgICAgICBfLmN1cnJlbnRTbGlkZSA9IDA7DQoNCiAgICAgICAgfQ0KDQogICAgICAgIGN1cnJlbnRTbGlkZSA9IF8uY3VycmVudFNsaWRlOw0KDQogICAgICAgIF8uZGVzdHJveSh0cnVlKTsNCg0KICAgICAgICAkLmV4dGVuZChfLCBfLmluaXRpYWxzLCB7IGN1cnJlbnRTbGlkZTogY3VycmVudFNsaWRlIH0pOw0KDQogICAgICAgIF8uaW5pdCgpOw0KDQogICAgICAgIGlmICghaW5pdGlhbGl6aW5nKSB7DQoNCiAgICAgICAgICAgIF8uY2hhbmdlU2xpZGUoew0KICAgICAgICAgICAgICAgIGRhdGE6IHsNCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ2luZGV4JywNCiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGN1cnJlbnRTbGlkZQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sIGZhbHNlKTsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnJlZ2lzdGVyQnJlYWtwb2ludHMgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLCBicmVha3BvaW50LCBjdXJyZW50QnJlYWtwb2ludCwgbCwNCiAgICAgICAgICAgIHJlc3BvbnNpdmVTZXR0aW5ncyA9IF8ub3B0aW9ucy5yZXNwb25zaXZlIHx8IG51bGw7DQoNCiAgICAgICAgaWYgKCQudHlwZShyZXNwb25zaXZlU2V0dGluZ3MpID09PSAnYXJyYXknICYmIHJlc3BvbnNpdmVTZXR0aW5ncy5sZW5ndGgpIHsNCg0KICAgICAgICAgICAgXy5yZXNwb25kVG8gPSBfLm9wdGlvbnMucmVzcG9uZFRvIHx8ICd3aW5kb3cnOw0KDQogICAgICAgICAgICBmb3IgKGJyZWFrcG9pbnQgaW4gcmVzcG9uc2l2ZVNldHRpbmdzKSB7DQoNCiAgICAgICAgICAgICAgICBsID0gXy5icmVha3BvaW50cy5sZW5ndGggLSAxOw0KICAgICAgICAgICAgICAgIGN1cnJlbnRCcmVha3BvaW50ID0gcmVzcG9uc2l2ZVNldHRpbmdzW2JyZWFrcG9pbnRdLmJyZWFrcG9pbnQ7DQoNCiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2l2ZVNldHRpbmdzLmhhc093blByb3BlcnR5KGJyZWFrcG9pbnQpKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gbG9vcCB0aHJvdWdoIHRoZSBicmVha3BvaW50cyBhbmQgY3V0IG91dCBhbnkgZXhpc3RpbmcNCiAgICAgICAgICAgICAgICAgICAgLy8gb25lcyB3aXRoIHRoZSBzYW1lIGJyZWFrcG9pbnQgbnVtYmVyLCB3ZSBkb24ndCB3YW50IGR1cGVzLg0KICAgICAgICAgICAgICAgICAgICB3aGlsZSAobCA+PSAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5icmVha3BvaW50c1tsXSAmJiBfLmJyZWFrcG9pbnRzW2xdID09PSBjdXJyZW50QnJlYWtwb2ludCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uYnJlYWtwb2ludHMuc3BsaWNlKGwsIDEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgbC0tOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgXy5icmVha3BvaW50cy5wdXNoKGN1cnJlbnRCcmVha3BvaW50KTsNCiAgICAgICAgICAgICAgICAgICAgXy5icmVha3BvaW50U2V0dGluZ3NbY3VycmVudEJyZWFrcG9pbnRdID0gcmVzcG9uc2l2ZVNldHRpbmdzW2JyZWFrcG9pbnRdLnNldHRpbmdzOw0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIF8uYnJlYWtwb2ludHMuc29ydChmdW5jdGlvbiAoYSwgYikgew0KICAgICAgICAgICAgICAgIHJldHVybiAoXy5vcHRpb25zLm1vYmlsZUZpcnN0KSA/IGEgLSBiIDogYiAtIGE7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnJlaW5pdCA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy4kc2xpZGVzID0NCiAgICAgICAgICAgIF8uJHNsaWRlVHJhY2sNCiAgICAgICAgICAgICAgICAuY2hpbGRyZW4oXy5vcHRpb25zLnNsaWRlKQ0KICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc2xpY2stc2xpZGUnKTsNCg0KICAgICAgICBfLnNsaWRlQ291bnQgPSBfLiRzbGlkZXMubGVuZ3RoOw0KDQogICAgICAgIGlmIChfLmN1cnJlbnRTbGlkZSA+PSBfLnNsaWRlQ291bnQgJiYgXy5jdXJyZW50U2xpZGUgIT09IDApIHsNCiAgICAgICAgICAgIF8uY3VycmVudFNsaWRlID0gXy5jdXJyZW50U2xpZGUgLSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGw7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5zbGlkZUNvdW50IDw9IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCiAgICAgICAgICAgIF8uY3VycmVudFNsaWRlID0gMDsNCiAgICAgICAgfQ0KDQogICAgICAgIF8ucmVnaXN0ZXJCcmVha3BvaW50cygpOw0KDQogICAgICAgIF8uc2V0UHJvcHMoKTsNCiAgICAgICAgXy5zZXR1cEluZmluaXRlKCk7DQogICAgICAgIF8uYnVpbGRBcnJvd3MoKTsNCiAgICAgICAgXy51cGRhdGVBcnJvd3MoKTsNCiAgICAgICAgXy5pbml0QXJyb3dFdmVudHMoKTsNCiAgICAgICAgXy5idWlsZERvdHMoKTsNCiAgICAgICAgXy51cGRhdGVEb3RzKCk7DQogICAgICAgIF8uaW5pdERvdEV2ZW50cygpOw0KICAgICAgICBfLmNsZWFuVXBTbGlkZUV2ZW50cygpOw0KICAgICAgICBfLmluaXRTbGlkZUV2ZW50cygpOw0KDQogICAgICAgIF8uY2hlY2tSZXNwb25zaXZlKGZhbHNlLCB0cnVlKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmZvY3VzT25TZWxlY3QgPT09IHRydWUpIHsNCiAgICAgICAgICAgICQoXy4kc2xpZGVUcmFjaykuY2hpbGRyZW4oKS5vbignY2xpY2suc2xpY2snLCBfLnNlbGVjdEhhbmRsZXIpOw0KICAgICAgICB9DQoNCiAgICAgICAgXy5zZXRTbGlkZUNsYXNzZXModHlwZW9mIF8uY3VycmVudFNsaWRlID09PSAnbnVtYmVyJyA/IF8uY3VycmVudFNsaWRlIDogMCk7DQoNCiAgICAgICAgXy5zZXRQb3NpdGlvbigpOw0KICAgICAgICBfLmZvY3VzSGFuZGxlcigpOw0KDQogICAgICAgIF8ucGF1c2VkID0gIV8ub3B0aW9ucy5hdXRvcGxheTsNCiAgICAgICAgXy5hdXRvUGxheSgpOw0KDQogICAgICAgIF8uJHNsaWRlci50cmlnZ2VyKCdyZUluaXQnLCBbX10pOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSAhPT0gXy53aW5kb3dXaWR0aCkgew0KICAgICAgICAgICAgY2xlYXJUaW1lb3V0KF8ud2luZG93RGVsYXkpOw0KICAgICAgICAgICAgXy53aW5kb3dEZWxheSA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBfLndpbmRvd1dpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7DQogICAgICAgICAgICAgICAgXy5jaGVja1Jlc3BvbnNpdmUoKTsNCiAgICAgICAgICAgICAgICBpZiAoIV8udW5zbGlja2VkKSB7IF8uc2V0UG9zaXRpb24oKTsgfQ0KICAgICAgICAgICAgfSwgNTApOw0KICAgICAgICB9DQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5yZW1vdmVTbGlkZSA9IFNsaWNrLnByb3RvdHlwZS5zbGlja1JlbW92ZSA9IGZ1bmN0aW9uIChpbmRleCwgcmVtb3ZlQmVmb3JlLCByZW1vdmVBbGwpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHR5cGVvZiAoaW5kZXgpID09PSAnYm9vbGVhbicpIHsNCiAgICAgICAgICAgIHJlbW92ZUJlZm9yZSA9IGluZGV4Ow0KICAgICAgICAgICAgaW5kZXggPSByZW1vdmVCZWZvcmUgPT09IHRydWUgPyAwIDogXy5zbGlkZUNvdW50IC0gMTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGluZGV4ID0gcmVtb3ZlQmVmb3JlID09PSB0cnVlID8gLS1pbmRleCA6IGluZGV4Ow0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8uc2xpZGVDb3VudCA8IDEgfHwgaW5kZXggPCAwIHx8IGluZGV4ID4gXy5zbGlkZUNvdW50IC0gMSkgew0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgXy51bmxvYWQoKTsNCg0KICAgICAgICBpZiAocmVtb3ZlQWxsID09PSB0cnVlKSB7DQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKCkucmVtb3ZlKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5zbGlkZSkuZXEoaW5kZXgpLnJlbW92ZSgpOw0KICAgICAgICB9DQoNCiAgICAgICAgXy4kc2xpZGVzID0gXy4kc2xpZGVUcmFjay5jaGlsZHJlbih0aGlzLm9wdGlvbnMuc2xpZGUpOw0KDQogICAgICAgIF8uJHNsaWRlVHJhY2suY2hpbGRyZW4odGhpcy5vcHRpb25zLnNsaWRlKS5kZXRhY2goKTsNCg0KICAgICAgICBfLiRzbGlkZVRyYWNrLmFwcGVuZChfLiRzbGlkZXMpOw0KDQogICAgICAgIF8uJHNsaWRlc0NhY2hlID0gXy4kc2xpZGVzOw0KDQogICAgICAgIF8ucmVpbml0KCk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnNldENTUyA9IGZ1bmN0aW9uIChwb3NpdGlvbikgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIHBvc2l0aW9uUHJvcHMgPSB7fSwNCiAgICAgICAgICAgIHgsIHk7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5ydGwgPT09IHRydWUpIHsNCiAgICAgICAgICAgIHBvc2l0aW9uID0gLXBvc2l0aW9uOw0KICAgICAgICB9DQogICAgICAgIHggPSBfLnBvc2l0aW9uUHJvcCA9PSAnbGVmdCcgPyBNYXRoLmNlaWwocG9zaXRpb24pICsgJ3B4JyA6ICcwcHgnOw0KICAgICAgICB5ID0gXy5wb3NpdGlvblByb3AgPT0gJ3RvcCcgPyBNYXRoLmNlaWwocG9zaXRpb24pICsgJ3B4JyA6ICcwcHgnOw0KDQogICAgICAgIHBvc2l0aW9uUHJvcHNbXy5wb3NpdGlvblByb3BdID0gcG9zaXRpb247DQoNCiAgICAgICAgaWYgKF8udHJhbnNmb3Jtc0VuYWJsZWQgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNzcyhwb3NpdGlvblByb3BzKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHBvc2l0aW9uUHJvcHMgPSB7fTsNCiAgICAgICAgICAgIGlmIChfLmNzc1RyYW5zaXRpb25zID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIHBvc2l0aW9uUHJvcHNbXy5hbmltVHlwZV0gPSAndHJhbnNsYXRlKCcgKyB4ICsgJywgJyArIHkgKyAnKSc7DQogICAgICAgICAgICAgICAgXy4kc2xpZGVUcmFjay5jc3MocG9zaXRpb25Qcm9wcyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHBvc2l0aW9uUHJvcHNbXy5hbmltVHlwZV0gPSAndHJhbnNsYXRlM2QoJyArIHggKyAnLCAnICsgeSArICcsIDBweCknOw0KICAgICAgICAgICAgICAgIF8uJHNsaWRlVHJhY2suY3NzKHBvc2l0aW9uUHJvcHMpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnNldERpbWVuc2lvbnMgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMudmVydGljYWwgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBpZiAoXy5vcHRpb25zLmNlbnRlck1vZGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICBfLiRsaXN0LmNzcyh7DQogICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICgnMHB4ICcgKyBfLm9wdGlvbnMuY2VudGVyUGFkZGluZykNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIF8uJGxpc3QuaGVpZ2h0KF8uJHNsaWRlcy5maXJzdCgpLm91dGVySGVpZ2h0KHRydWUpICogXy5vcHRpb25zLnNsaWRlc1RvU2hvdyk7DQogICAgICAgICAgICBpZiAoXy5vcHRpb25zLmNlbnRlck1vZGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICBfLiRsaXN0LmNzcyh7DQogICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IChfLm9wdGlvbnMuY2VudGVyUGFkZGluZyArICcgMHB4JykNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIF8ubGlzdFdpZHRoID0gXy4kbGlzdC53aWR0aCgpOw0KICAgICAgICBfLmxpc3RIZWlnaHQgPSBfLiRsaXN0LmhlaWdodCgpOw0KDQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy52ZXJ0aWNhbCA9PT0gZmFsc2UgJiYgXy5vcHRpb25zLnZhcmlhYmxlV2lkdGggPT09IGZhbHNlKSB7DQogICAgICAgICAgICBfLnNsaWRlV2lkdGggPSBNYXRoLmNlaWwoXy5saXN0V2lkdGggLyBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KTsNCiAgICAgICAgICAgIF8uJHNsaWRlVHJhY2sud2lkdGgoTWF0aC5jZWlsKChfLnNsaWRlV2lkdGggKiBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKCcuc2xpY2stc2xpZGUnKS5sZW5ndGgpKSk7DQoNCiAgICAgICAgfSBlbHNlIGlmIChfLm9wdGlvbnMudmFyaWFibGVXaWR0aCA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy4kc2xpZGVUcmFjay53aWR0aCg1MDAwICogXy5zbGlkZUNvdW50KTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIF8uc2xpZGVXaWR0aCA9IE1hdGguY2VpbChfLmxpc3RXaWR0aCk7DQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmhlaWdodChNYXRoLmNlaWwoKF8uJHNsaWRlcy5maXJzdCgpLm91dGVySGVpZ2h0KHRydWUpICogXy4kc2xpZGVUcmFjay5jaGlsZHJlbignLnNsaWNrLXNsaWRlJykubGVuZ3RoKSkpOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIG9mZnNldCA9IF8uJHNsaWRlcy5maXJzdCgpLm91dGVyV2lkdGgodHJ1ZSkgLSBfLiRzbGlkZXMuZmlyc3QoKS53aWR0aCgpOw0KICAgICAgICBpZiAoXy5vcHRpb25zLnZhcmlhYmxlV2lkdGggPT09IGZhbHNlKSBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKCcuc2xpY2stc2xpZGUnKS53aWR0aChfLnNsaWRlV2lkdGggLSBvZmZzZXQpOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zZXRGYWRlID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIHRhcmdldExlZnQ7DQoNCiAgICAgICAgXy4kc2xpZGVzLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7DQogICAgICAgICAgICB0YXJnZXRMZWZ0ID0gKF8uc2xpZGVXaWR0aCAqIGluZGV4KSAqIC0xOw0KICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5ydGwgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAkKGVsZW1lbnQpLmNzcyh7DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAncmVsYXRpdmUnLA0KICAgICAgICAgICAgICAgICAgICByaWdodDogdGFyZ2V0TGVmdCwNCiAgICAgICAgICAgICAgICAgICAgdG9wOiAwLA0KICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IF8ub3B0aW9ucy56SW5kZXggLSAyLA0KICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICQoZWxlbWVudCkuY3NzKHsNCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICdyZWxhdGl2ZScsDQogICAgICAgICAgICAgICAgICAgIGxlZnQ6IHRhcmdldExlZnQsDQogICAgICAgICAgICAgICAgICAgIHRvcDogMCwNCiAgICAgICAgICAgICAgICAgICAgekluZGV4OiBfLm9wdGlvbnMuekluZGV4IC0gMiwNCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMA0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICBfLiRzbGlkZXMuZXEoXy5jdXJyZW50U2xpZGUpLmNzcyh7DQogICAgICAgICAgICB6SW5kZXg6IF8ub3B0aW9ucy56SW5kZXggLSAxLA0KICAgICAgICAgICAgb3BhY2l0eTogMQ0KICAgICAgICB9KTsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuc2V0SGVpZ2h0ID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyA9PT0gMSAmJiBfLm9wdGlvbnMuYWRhcHRpdmVIZWlnaHQgPT09IHRydWUgJiYgXy5vcHRpb25zLnZlcnRpY2FsID09PSBmYWxzZSkgew0KICAgICAgICAgICAgdmFyIHRhcmdldEhlaWdodCA9IF8uJHNsaWRlcy5lcShfLmN1cnJlbnRTbGlkZSkub3V0ZXJIZWlnaHQodHJ1ZSk7DQogICAgICAgICAgICBfLiRsaXN0LmNzcygnaGVpZ2h0JywgdGFyZ2V0SGVpZ2h0KTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zZXRPcHRpb24gPQ0KICAgICAgICBTbGljay5wcm90b3R5cGUuc2xpY2tTZXRPcHRpb24gPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgICAgIC8qKg0KICAgICAgICAgICAgICogYWNjZXB0cyBhcmd1bWVudHMgaW4gZm9ybWF0IG9mOg0KICAgICAgICAgICAgICoNCiAgICAgICAgICAgICAqICAtIGZvciBjaGFuZ2luZyBhIHNpbmdsZSBvcHRpb24ncyB2YWx1ZToNCiAgICAgICAgICAgICAqICAgICAuc2xpY2soInNldE9wdGlvbiIsIG9wdGlvbiwgdmFsdWUsIHJlZnJlc2ggKQ0KICAgICAgICAgICAgICoNCiAgICAgICAgICAgICAqICAtIGZvciBjaGFuZ2luZyBhIHNldCBvZiByZXNwb25zaXZlIG9wdGlvbnM6DQogICAgICAgICAgICAgKiAgICAgLnNsaWNrKCJzZXRPcHRpb24iLCAncmVzcG9uc2l2ZScsIFt7fSwgLi4uXSwgcmVmcmVzaCApDQogICAgICAgICAgICAgKg0KICAgICAgICAgICAgICogIC0gZm9yIHVwZGF0aW5nIG11bHRpcGxlIHZhbHVlcyBhdCBvbmNlIChub3QgcmVzcG9uc2l2ZSkNCiAgICAgICAgICAgICAqICAgICAuc2xpY2soInNldE9wdGlvbiIsIHsgJ29wdGlvbic6IHZhbHVlLCAuLi4gfSwgcmVmcmVzaCApDQogICAgICAgICAgICAgKi8NCg0KICAgICAgICAgICAgdmFyIF8gPSB0aGlzLCBsLCBpdGVtLCBvcHRpb24sIHZhbHVlLCByZWZyZXNoID0gZmFsc2UsIHR5cGU7DQoNCiAgICAgICAgICAgIGlmICgkLnR5cGUoYXJndW1lbnRzWzBdKSA9PT0gJ29iamVjdCcpIHsNCg0KICAgICAgICAgICAgICAgIG9wdGlvbiA9IGFyZ3VtZW50c1swXTsNCiAgICAgICAgICAgICAgICByZWZyZXNoID0gYXJndW1lbnRzWzFdOw0KICAgICAgICAgICAgICAgIHR5cGUgPSAnbXVsdGlwbGUnOw0KDQogICAgICAgICAgICB9IGVsc2UgaWYgKCQudHlwZShhcmd1bWVudHNbMF0pID09PSAnc3RyaW5nJykgew0KDQogICAgICAgICAgICAgICAgb3B0aW9uID0gYXJndW1lbnRzWzBdOw0KICAgICAgICAgICAgICAgIHZhbHVlID0gYXJndW1lbnRzWzFdOw0KICAgICAgICAgICAgICAgIHJlZnJlc2ggPSBhcmd1bWVudHNbMl07DQoNCiAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzWzBdID09PSAncmVzcG9uc2l2ZScgJiYgJC50eXBlKGFyZ3VtZW50c1sxXSkgPT09ICdhcnJheScpIHsNCg0KICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ3Jlc3BvbnNpdmUnOw0KDQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdICE9PSAndW5kZWZpbmVkJykgew0KDQogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnc2luZ2xlJzsNCg0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NpbmdsZScpIHsNCg0KICAgICAgICAgICAgICAgIF8ub3B0aW9uc1tvcHRpb25dID0gdmFsdWU7DQoNCg0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbXVsdGlwbGUnKSB7DQoNCiAgICAgICAgICAgICAgICAkLmVhY2gob3B0aW9uLCBmdW5jdGlvbiAob3B0LCB2YWwpIHsNCg0KICAgICAgICAgICAgICAgICAgICBfLm9wdGlvbnNbb3B0XSA9IHZhbDsNCg0KICAgICAgICAgICAgICAgIH0pOw0KDQoNCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Jlc3BvbnNpdmUnKSB7DQoNCiAgICAgICAgICAgICAgICBmb3IgKGl0ZW0gaW4gdmFsdWUpIHsNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoJC50eXBlKF8ub3B0aW9ucy5yZXNwb25zaXZlKSAhPT0gJ2FycmF5Jykgew0KDQogICAgICAgICAgICAgICAgICAgICAgICBfLm9wdGlvbnMucmVzcG9uc2l2ZSA9IFt2YWx1ZVtpdGVtXV07DQoNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgbCA9IF8ub3B0aW9ucy5yZXNwb25zaXZlLmxlbmd0aCAtIDE7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxvb3AgdGhyb3VnaCB0aGUgcmVzcG9uc2l2ZSBvYmplY3QgYW5kIHNwbGljZSBvdXQgZHVwbGljYXRlcy4NCiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsID49IDApIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfLm9wdGlvbnMucmVzcG9uc2l2ZVtsXS5icmVha3BvaW50ID09PSB2YWx1ZVtpdGVtXS5icmVha3BvaW50KSB7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5vcHRpb25zLnJlc3BvbnNpdmUuc3BsaWNlKGwsIDEpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbC0tOw0KDQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIF8ub3B0aW9ucy5yZXNwb25zaXZlLnB1c2godmFsdWVbaXRlbV0pOw0KDQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAocmVmcmVzaCkgew0KDQogICAgICAgICAgICAgICAgXy51bmxvYWQoKTsNCiAgICAgICAgICAgICAgICBfLnJlaW5pdCgpOw0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zZXRQb3NpdGlvbiA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgXy5zZXREaW1lbnNpb25zKCk7DQoNCiAgICAgICAgXy5zZXRIZWlnaHQoKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmZhZGUgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBfLnNldENTUyhfLmdldExlZnQoXy5jdXJyZW50U2xpZGUpKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIF8uc2V0RmFkZSgpOw0KICAgICAgICB9DQoNCiAgICAgICAgXy4kc2xpZGVyLnRyaWdnZXIoJ3NldFBvc2l0aW9uJywgW19dKTsNCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuc2V0UHJvcHMgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgYm9keVN0eWxlID0gZG9jdW1lbnQuYm9keS5zdHlsZTsNCg0KICAgICAgICBfLnBvc2l0aW9uUHJvcCA9IF8ub3B0aW9ucy52ZXJ0aWNhbCA9PT0gdHJ1ZSA/ICd0b3AnIDogJ2xlZnQnOw0KDQogICAgICAgIGlmIChfLnBvc2l0aW9uUHJvcCA9PT0gJ3RvcCcpIHsNCiAgICAgICAgICAgIF8uJHNsaWRlci5hZGRDbGFzcygnc2xpY2stdmVydGljYWwnKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIF8uJHNsaWRlci5yZW1vdmVDbGFzcygnc2xpY2stdmVydGljYWwnKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChib2R5U3R5bGUuV2Via2l0VHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkIHx8DQogICAgICAgICAgICBib2R5U3R5bGUuTW96VHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkIHx8DQogICAgICAgICAgICBib2R5U3R5bGUubXNUcmFuc2l0aW9uICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgIGlmIChfLm9wdGlvbnMudXNlQ1NTID09PSB0cnVlKSB7DQogICAgICAgICAgICAgICAgXy5jc3NUcmFuc2l0aW9ucyA9IHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmZhZGUpIHsNCiAgICAgICAgICAgIGlmICh0eXBlb2YgXy5vcHRpb25zLnpJbmRleCA9PT0gJ251bWJlcicpIHsNCiAgICAgICAgICAgICAgICBpZiAoXy5vcHRpb25zLnpJbmRleCA8IDMpIHsNCiAgICAgICAgICAgICAgICAgICAgXy5vcHRpb25zLnpJbmRleCA9IDM7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBfLm9wdGlvbnMuekluZGV4ID0gXy5kZWZhdWx0cy56SW5kZXg7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoYm9keVN0eWxlLk9UcmFuc2Zvcm0gIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgXy5hbmltVHlwZSA9ICdPVHJhbnNmb3JtJzsNCiAgICAgICAgICAgIF8udHJhbnNmb3JtVHlwZSA9ICctby10cmFuc2Zvcm0nOw0KICAgICAgICAgICAgXy50cmFuc2l0aW9uVHlwZSA9ICdPVHJhbnNpdGlvbic7DQogICAgICAgICAgICBpZiAoYm9keVN0eWxlLnBlcnNwZWN0aXZlUHJvcGVydHkgPT09IHVuZGVmaW5lZCAmJiBib2R5U3R5bGUud2Via2l0UGVyc3BlY3RpdmUgPT09IHVuZGVmaW5lZCkgXy5hbmltVHlwZSA9IGZhbHNlOw0KICAgICAgICB9DQogICAgICAgIGlmIChib2R5U3R5bGUuTW96VHJhbnNmb3JtICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgIF8uYW5pbVR5cGUgPSAnTW96VHJhbnNmb3JtJzsNCiAgICAgICAgICAgIF8udHJhbnNmb3JtVHlwZSA9ICctbW96LXRyYW5zZm9ybSc7DQogICAgICAgICAgICBfLnRyYW5zaXRpb25UeXBlID0gJ01velRyYW5zaXRpb24nOw0KICAgICAgICAgICAgaWYgKGJvZHlTdHlsZS5wZXJzcGVjdGl2ZVByb3BlcnR5ID09PSB1bmRlZmluZWQgJiYgYm9keVN0eWxlLk1velBlcnNwZWN0aXZlID09PSB1bmRlZmluZWQpIF8uYW5pbVR5cGUgPSBmYWxzZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoYm9keVN0eWxlLndlYmtpdFRyYW5zZm9ybSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICBfLmFuaW1UeXBlID0gJ3dlYmtpdFRyYW5zZm9ybSc7DQogICAgICAgICAgICBfLnRyYW5zZm9ybVR5cGUgPSAnLXdlYmtpdC10cmFuc2Zvcm0nOw0KICAgICAgICAgICAgXy50cmFuc2l0aW9uVHlwZSA9ICd3ZWJraXRUcmFuc2l0aW9uJzsNCiAgICAgICAgICAgIGlmIChib2R5U3R5bGUucGVyc3BlY3RpdmVQcm9wZXJ0eSA9PT0gdW5kZWZpbmVkICYmIGJvZHlTdHlsZS53ZWJraXRQZXJzcGVjdGl2ZSA9PT0gdW5kZWZpbmVkKSBfLmFuaW1UeXBlID0gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGJvZHlTdHlsZS5tc1RyYW5zZm9ybSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICBfLmFuaW1UeXBlID0gJ21zVHJhbnNmb3JtJzsNCiAgICAgICAgICAgIF8udHJhbnNmb3JtVHlwZSA9ICctbXMtdHJhbnNmb3JtJzsNCiAgICAgICAgICAgIF8udHJhbnNpdGlvblR5cGUgPSAnbXNUcmFuc2l0aW9uJzsNCiAgICAgICAgICAgIGlmIChib2R5U3R5bGUubXNUcmFuc2Zvcm0gPT09IHVuZGVmaW5lZCkgXy5hbmltVHlwZSA9IGZhbHNlOw0KICAgICAgICB9DQogICAgICAgIGlmIChib2R5U3R5bGUudHJhbnNmb3JtICE9PSB1bmRlZmluZWQgJiYgXy5hbmltVHlwZSAhPT0gZmFsc2UpIHsNCiAgICAgICAgICAgIF8uYW5pbVR5cGUgPSAndHJhbnNmb3JtJzsNCiAgICAgICAgICAgIF8udHJhbnNmb3JtVHlwZSA9ICd0cmFuc2Zvcm0nOw0KICAgICAgICAgICAgXy50cmFuc2l0aW9uVHlwZSA9ICd0cmFuc2l0aW9uJzsNCiAgICAgICAgfQ0KICAgICAgICBfLnRyYW5zZm9ybXNFbmFibGVkID0gXy5vcHRpb25zLnVzZVRyYW5zZm9ybSAmJiAoXy5hbmltVHlwZSAhPT0gbnVsbCAmJiBfLmFuaW1UeXBlICE9PSBmYWxzZSk7DQogICAgfTsNCg0KDQogICAgU2xpY2sucHJvdG90eXBlLnNldFNsaWRlQ2xhc3NlcyA9IGZ1bmN0aW9uIChpbmRleCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIGNlbnRlck9mZnNldCwgYWxsU2xpZGVzLCBpbmRleE9mZnNldCwgcmVtYWluZGVyOw0KDQogICAgICAgIGFsbFNsaWRlcyA9IF8uJHNsaWRlcg0KICAgICAgICAgICAgLmZpbmQoJy5zbGljay1zbGlkZScpDQogICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3NsaWNrLWFjdGl2ZSBzbGljay1jZW50ZXIgc2xpY2stY3VycmVudCcpDQogICAgICAgICAgICAuYXR0cignYXJpYS1oaWRkZW4nLCAndHJ1ZScpOw0KDQogICAgICAgIF8uJHNsaWRlcw0KICAgICAgICAgICAgLmVxKGluZGV4KQ0KICAgICAgICAgICAgLmFkZENsYXNzKCdzbGljay1jdXJyZW50Jyk7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSB0cnVlKSB7DQoNCiAgICAgICAgICAgIGNlbnRlck9mZnNldCA9IE1hdGguZmxvb3IoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyAvIDIpOw0KDQogICAgICAgICAgICBpZiAoXy5vcHRpb25zLmluZmluaXRlID09PSB0cnVlKSB7DQoNCiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gY2VudGVyT2Zmc2V0ICYmIGluZGV4IDw9IChfLnNsaWRlQ291bnQgLSAxKSAtIGNlbnRlck9mZnNldCkgew0KDQogICAgICAgICAgICAgICAgICAgIF8uJHNsaWRlcw0KICAgICAgICAgICAgICAgICAgICAgICAgLnNsaWNlKGluZGV4IC0gY2VudGVyT2Zmc2V0LCBpbmRleCArIGNlbnRlck9mZnNldCArIDEpDQogICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWFjdGl2ZScpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignYXJpYS1oaWRkZW4nLCAnZmFsc2UnKTsNCg0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQoNCiAgICAgICAgICAgICAgICAgICAgaW5kZXhPZmZzZXQgPSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93ICsgaW5kZXg7DQogICAgICAgICAgICAgICAgICAgIGFsbFNsaWRlcw0KICAgICAgICAgICAgICAgICAgICAgICAgLnNsaWNlKGluZGV4T2Zmc2V0IC0gY2VudGVyT2Zmc2V0ICsgMSwgaW5kZXhPZmZzZXQgKyBjZW50ZXJPZmZzZXQgKyAyKQ0KICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdzbGljay1hY3RpdmUnKQ0KICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ2FyaWEtaGlkZGVuJywgJ2ZhbHNlJyk7DQoNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHsNCg0KICAgICAgICAgICAgICAgICAgICBhbGxTbGlkZXMNCiAgICAgICAgICAgICAgICAgICAgICAgIC5lcShhbGxTbGlkZXMubGVuZ3RoIC0gMSAtIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpDQogICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWNlbnRlcicpOw0KDQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9PT0gXy5zbGlkZUNvdW50IC0gMSkgew0KDQogICAgICAgICAgICAgICAgICAgIGFsbFNsaWRlcw0KICAgICAgICAgICAgICAgICAgICAgICAgLmVxKF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpDQogICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWNlbnRlcicpOw0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIF8uJHNsaWRlcw0KICAgICAgICAgICAgICAgIC5lcShpbmRleCkNCiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWNlbnRlcicpOw0KDQogICAgICAgIH0gZWxzZSB7DQoNCiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDw9IChfLnNsaWRlQ291bnQgLSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSkgew0KDQogICAgICAgICAgICAgICAgXy4kc2xpZGVzDQogICAgICAgICAgICAgICAgICAgIC5zbGljZShpbmRleCwgaW5kZXggKyBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KQ0KICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWFjdGl2ZScpDQogICAgICAgICAgICAgICAgICAgIC5hdHRyKCdhcmlhLWhpZGRlbicsICdmYWxzZScpOw0KDQogICAgICAgICAgICB9IGVsc2UgaWYgKGFsbFNsaWRlcy5sZW5ndGggPD0gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KDQogICAgICAgICAgICAgICAgYWxsU2xpZGVzDQogICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc2xpY2stYWN0aXZlJykNCiAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ2FyaWEtaGlkZGVuJywgJ2ZhbHNlJyk7DQoNCiAgICAgICAgICAgIH0gZWxzZSB7DQoNCiAgICAgICAgICAgICAgICByZW1haW5kZXIgPSBfLnNsaWRlQ291bnQgJSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93Ow0KICAgICAgICAgICAgICAgIGluZGV4T2Zmc2V0ID0gXy5vcHRpb25zLmluZmluaXRlID09PSB0cnVlID8gXy5vcHRpb25zLnNsaWRlc1RvU2hvdyArIGluZGV4IDogaW5kZXg7DQoNCiAgICAgICAgICAgICAgICBpZiAoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyA9PSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwgJiYgKF8uc2xpZGVDb3VudCAtIGluZGV4KSA8IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCg0KICAgICAgICAgICAgICAgICAgICBhbGxTbGlkZXMNCiAgICAgICAgICAgICAgICAgICAgICAgIC5zbGljZShpbmRleE9mZnNldCAtIChfLm9wdGlvbnMuc2xpZGVzVG9TaG93IC0gcmVtYWluZGVyKSwgaW5kZXhPZmZzZXQgKyByZW1haW5kZXIpDQogICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWFjdGl2ZScpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignYXJpYS1oaWRkZW4nLCAnZmFsc2UnKTsNCg0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQoNCiAgICAgICAgICAgICAgICAgICAgYWxsU2xpZGVzDQogICAgICAgICAgICAgICAgICAgICAgICAuc2xpY2UoaW5kZXhPZmZzZXQsIGluZGV4T2Zmc2V0ICsgXy5vcHRpb25zLnNsaWRlc1RvU2hvdykNCiAgICAgICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc2xpY2stYWN0aXZlJykNCiAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdhcmlhLWhpZGRlbicsICdmYWxzZScpOw0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMubGF6eUxvYWQgPT09ICdvbmRlbWFuZCcpIHsNCiAgICAgICAgICAgIF8ubGF6eUxvYWQoKTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zZXR1cEluZmluaXRlID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIGksIHNsaWRlSW5kZXgsIGluZmluaXRlQ291bnQ7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5mYWRlID09PSB0cnVlKSB7DQogICAgICAgICAgICBfLm9wdGlvbnMuY2VudGVyTW9kZSA9IGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gdHJ1ZSAmJiBfLm9wdGlvbnMuZmFkZSA9PT0gZmFsc2UpIHsNCg0KICAgICAgICAgICAgc2xpZGVJbmRleCA9IG51bGw7DQoNCiAgICAgICAgICAgIGlmIChfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQoNCiAgICAgICAgICAgICAgICBpZiAoXy5vcHRpb25zLmNlbnRlck1vZGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgaW5maW5pdGVDb3VudCA9IF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgKyAxOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGluZmluaXRlQ291bnQgPSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93Ow0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGZvciAoaSA9IF8uc2xpZGVDb3VudDsgaSA+IChfLnNsaWRlQ291bnQgLQ0KICAgICAgICAgICAgICAgICAgICBpbmZpbml0ZUNvdW50KTsgaSAtPSAxKSB7DQogICAgICAgICAgICAgICAgICAgIHNsaWRlSW5kZXggPSBpIC0gMTsNCiAgICAgICAgICAgICAgICAgICAgJChfLiRzbGlkZXNbc2xpZGVJbmRleF0pLmNsb25lKHRydWUpLmF0dHIoJ2lkJywgJycpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZGF0YS1zbGljay1pbmRleCcsIHNsaWRlSW5kZXggLSBfLnNsaWRlQ291bnQpDQogICAgICAgICAgICAgICAgICAgICAgICAucHJlcGVuZFRvKF8uJHNsaWRlVHJhY2spLmFkZENsYXNzKCdzbGljay1jbG9uZWQnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGluZmluaXRlQ291bnQ7IGkgKz0gMSkgew0KICAgICAgICAgICAgICAgICAgICBzbGlkZUluZGV4ID0gaTsNCiAgICAgICAgICAgICAgICAgICAgJChfLiRzbGlkZXNbc2xpZGVJbmRleF0pLmNsb25lKHRydWUpLmF0dHIoJ2lkJywgJycpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZGF0YS1zbGljay1pbmRleCcsIHNsaWRlSW5kZXggKyBfLnNsaWRlQ291bnQpDQogICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kVG8oXy4kc2xpZGVUcmFjaykuYWRkQ2xhc3MoJ3NsaWNrLWNsb25lZCcpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmZpbmQoJy5zbGljay1jbG9uZWQnKS5maW5kKCdbaWRdJykuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuYXR0cignaWQnLCAnJyk7DQogICAgICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLmludGVycnVwdCA9IGZ1bmN0aW9uICh0b2dnbGUpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKCF0b2dnbGUpIHsNCiAgICAgICAgICAgIF8uYXV0b1BsYXkoKTsNCiAgICAgICAgfQ0KICAgICAgICBfLmludGVycnVwdGVkID0gdG9nZ2xlOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zZWxlY3RIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0NCiAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5pcygnLnNsaWNrLXNsaWRlJykgPw0KICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KSA6DQogICAgICAgICAgICAgICAgJChldmVudC50YXJnZXQpLnBhcmVudHMoJy5zbGljay1zbGlkZScpOw0KDQogICAgICAgIHZhciBpbmRleCA9IHBhcnNlSW50KHRhcmdldEVsZW1lbnQuYXR0cignZGF0YS1zbGljay1pbmRleCcpKTsNCg0KICAgICAgICBpZiAoIWluZGV4KSBpbmRleCA9IDA7DQoNCiAgICAgICAgaWYgKF8uc2xpZGVDb3VudCA8PSBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQoNCiAgICAgICAgICAgIF8uc2V0U2xpZGVDbGFzc2VzKGluZGV4KTsNCiAgICAgICAgICAgIF8uYXNOYXZGb3IoaW5kZXgpOw0KICAgICAgICAgICAgcmV0dXJuOw0KDQogICAgICAgIH0NCg0KICAgICAgICBfLnNsaWRlSGFuZGxlcihpbmRleCk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnNsaWRlSGFuZGxlciA9IGZ1bmN0aW9uIChpbmRleCwgc3luYywgZG9udEFuaW1hdGUpIHsNCg0KICAgICAgICB2YXIgdGFyZ2V0U2xpZGUsIGFuaW1TbGlkZSwgb2xkU2xpZGUsIHNsaWRlTGVmdCwgdGFyZ2V0TGVmdCA9IG51bGwsDQogICAgICAgICAgICBfID0gdGhpcywgbmF2VGFyZ2V0Ow0KDQogICAgICAgIHN5bmMgPSBzeW5jIHx8IGZhbHNlOw0KDQogICAgICAgIGlmIChfLmFuaW1hdGluZyA9PT0gdHJ1ZSAmJiBfLm9wdGlvbnMud2FpdEZvckFuaW1hdGUgPT09IHRydWUpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuZmFkZSA9PT0gdHJ1ZSAmJiBfLmN1cnJlbnRTbGlkZSA9PT0gaW5kZXgpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLnNsaWRlQ291bnQgPD0gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHN5bmMgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBfLmFzTmF2Rm9yKGluZGV4KTsNCiAgICAgICAgfQ0KDQogICAgICAgIHRhcmdldFNsaWRlID0gaW5kZXg7DQogICAgICAgIHRhcmdldExlZnQgPSBfLmdldExlZnQodGFyZ2V0U2xpZGUpOw0KICAgICAgICBzbGlkZUxlZnQgPSBfLmdldExlZnQoXy5jdXJyZW50U2xpZGUpOw0KDQogICAgICAgIF8uY3VycmVudExlZnQgPSBfLnN3aXBlTGVmdCA9PT0gbnVsbCA/IHNsaWRlTGVmdCA6IF8uc3dpcGVMZWZ0Ow0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuaW5maW5pdGUgPT09IGZhbHNlICYmIF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSBmYWxzZSAmJiAoaW5kZXggPCAwIHx8IGluZGV4ID4gXy5nZXREb3RDb3VudCgpICogXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsKSkgew0KICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5mYWRlID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIHRhcmdldFNsaWRlID0gXy5jdXJyZW50U2xpZGU7DQogICAgICAgICAgICAgICAgaWYgKGRvbnRBbmltYXRlICE9PSB0cnVlKSB7DQogICAgICAgICAgICAgICAgICAgIF8uYW5pbWF0ZVNsaWRlKHNsaWRlTGVmdCwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgXy5wb3N0U2xpZGUodGFyZ2V0U2xpZGUpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBfLnBvc3RTbGlkZSh0YXJnZXRTbGlkZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9IGVsc2UgaWYgKF8ub3B0aW9ucy5pbmZpbml0ZSA9PT0gZmFsc2UgJiYgXy5vcHRpb25zLmNlbnRlck1vZGUgPT09IHRydWUgJiYgKGluZGV4IDwgMCB8fCBpbmRleCA+IChfLnNsaWRlQ291bnQgLSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwpKSkgew0KICAgICAgICAgICAgaWYgKF8ub3B0aW9ucy5mYWRlID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIHRhcmdldFNsaWRlID0gXy5jdXJyZW50U2xpZGU7DQogICAgICAgICAgICAgICAgaWYgKGRvbnRBbmltYXRlICE9PSB0cnVlKSB7DQogICAgICAgICAgICAgICAgICAgIF8uYW5pbWF0ZVNsaWRlKHNsaWRlTGVmdCwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgXy5wb3N0U2xpZGUodGFyZ2V0U2xpZGUpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBfLnBvc3RTbGlkZSh0YXJnZXRTbGlkZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5hdXRvcGxheSkgew0KICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChfLmF1dG9QbGF5VGltZXIpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRhcmdldFNsaWRlIDwgMCkgew0KICAgICAgICAgICAgaWYgKF8uc2xpZGVDb3VudCAlIF8ub3B0aW9ucy5zbGlkZXNUb1Njcm9sbCAhPT0gMCkgew0KICAgICAgICAgICAgICAgIGFuaW1TbGlkZSA9IF8uc2xpZGVDb3VudCAtIChfLnNsaWRlQ291bnQgJSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBhbmltU2xpZGUgPSBfLnNsaWRlQ291bnQgKyB0YXJnZXRTbGlkZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRTbGlkZSA+PSBfLnNsaWRlQ291bnQpIHsNCiAgICAgICAgICAgIGlmIChfLnNsaWRlQ291bnQgJSBfLm9wdGlvbnMuc2xpZGVzVG9TY3JvbGwgIT09IDApIHsNCiAgICAgICAgICAgICAgICBhbmltU2xpZGUgPSAwOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBhbmltU2xpZGUgPSB0YXJnZXRTbGlkZSAtIF8uc2xpZGVDb3VudDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGFuaW1TbGlkZSA9IHRhcmdldFNsaWRlOw0KICAgICAgICB9DQoNCiAgICAgICAgXy5hbmltYXRpbmcgPSB0cnVlOw0KDQogICAgICAgIF8uJHNsaWRlci50cmlnZ2VyKCdiZWZvcmVDaGFuZ2UnLCBbXywgXy5jdXJyZW50U2xpZGUsIGFuaW1TbGlkZV0pOw0KDQogICAgICAgIG9sZFNsaWRlID0gXy5jdXJyZW50U2xpZGU7DQogICAgICAgIF8uY3VycmVudFNsaWRlID0gYW5pbVNsaWRlOw0KDQogICAgICAgIF8uc2V0U2xpZGVDbGFzc2VzKF8uY3VycmVudFNsaWRlKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmFzTmF2Rm9yKSB7DQoNCiAgICAgICAgICAgIG5hdlRhcmdldCA9IF8uZ2V0TmF2VGFyZ2V0KCk7DQogICAgICAgICAgICBuYXZUYXJnZXQgPSBuYXZUYXJnZXQuc2xpY2soJ2dldFNsaWNrJyk7DQoNCiAgICAgICAgICAgIGlmIChuYXZUYXJnZXQuc2xpZGVDb3VudCA8PSBuYXZUYXJnZXQub3B0aW9ucy5zbGlkZXNUb1Nob3cpIHsNCiAgICAgICAgICAgICAgICBuYXZUYXJnZXQuc2V0U2xpZGVDbGFzc2VzKF8uY3VycmVudFNsaWRlKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCiAgICAgICAgXy51cGRhdGVEb3RzKCk7DQogICAgICAgIF8udXBkYXRlQXJyb3dzKCk7DQoNCiAgICAgICAgaWYgKF8ub3B0aW9ucy5mYWRlID09PSB0cnVlKSB7DQogICAgICAgICAgICBpZiAoZG9udEFuaW1hdGUgIT09IHRydWUpIHsNCg0KICAgICAgICAgICAgICAgIF8uZmFkZVNsaWRlT3V0KG9sZFNsaWRlKTsNCg0KICAgICAgICAgICAgICAgIF8uZmFkZVNsaWRlKGFuaW1TbGlkZSwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICBfLnBvc3RTbGlkZShhbmltU2xpZGUpOw0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIF8ucG9zdFNsaWRlKGFuaW1TbGlkZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBfLmFuaW1hdGVIZWlnaHQoKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChkb250QW5pbWF0ZSAhPT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy5hbmltYXRlU2xpZGUodGFyZ2V0TGVmdCwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIF8ucG9zdFNsaWRlKGFuaW1TbGlkZSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIF8ucG9zdFNsaWRlKGFuaW1TbGlkZSk7DQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUuc3RhcnRMb2FkID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmFycm93cyA9PT0gdHJ1ZSAmJiBfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93KSB7DQoNCiAgICAgICAgICAgIF8uJHByZXZBcnJvdy5oaWRlKCk7DQogICAgICAgICAgICBfLiRuZXh0QXJyb3cuaGlkZSgpOw0KDQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmRvdHMgPT09IHRydWUgJiYgXy5zbGlkZUNvdW50ID4gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KDQogICAgICAgICAgICBfLiRkb3RzLmhpZGUoKTsNCg0KICAgICAgICB9DQoNCiAgICAgICAgXy4kc2xpZGVyLmFkZENsYXNzKCdzbGljay1sb2FkaW5nJyk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnN3aXBlRGlyZWN0aW9uID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciB4RGlzdCwgeURpc3QsIHIsIHN3aXBlQW5nbGUsIF8gPSB0aGlzOw0KDQogICAgICAgIHhEaXN0ID0gXy50b3VjaE9iamVjdC5zdGFydFggLSBfLnRvdWNoT2JqZWN0LmN1clg7DQogICAgICAgIHlEaXN0ID0gXy50b3VjaE9iamVjdC5zdGFydFkgLSBfLnRvdWNoT2JqZWN0LmN1clk7DQogICAgICAgIHIgPSBNYXRoLmF0YW4yKHlEaXN0LCB4RGlzdCk7DQoNCiAgICAgICAgc3dpcGVBbmdsZSA9IE1hdGgucm91bmQociAqIDE4MCAvIE1hdGguUEkpOw0KICAgICAgICBpZiAoc3dpcGVBbmdsZSA8IDApIHsNCiAgICAgICAgICAgIHN3aXBlQW5nbGUgPSAzNjAgLSBNYXRoLmFicyhzd2lwZUFuZ2xlKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICgoc3dpcGVBbmdsZSA8PSA0NSkgJiYgKHN3aXBlQW5nbGUgPj0gMCkpIHsNCiAgICAgICAgICAgIHJldHVybiAoXy5vcHRpb25zLnJ0bCA9PT0gZmFsc2UgPyAnbGVmdCcgOiAncmlnaHQnKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoKHN3aXBlQW5nbGUgPD0gMzYwKSAmJiAoc3dpcGVBbmdsZSA+PSAzMTUpKSB7DQogICAgICAgICAgICByZXR1cm4gKF8ub3B0aW9ucy5ydGwgPT09IGZhbHNlID8gJ2xlZnQnIDogJ3JpZ2h0Jyk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKChzd2lwZUFuZ2xlID49IDEzNSkgJiYgKHN3aXBlQW5nbGUgPD0gMjI1KSkgew0KICAgICAgICAgICAgcmV0dXJuIChfLm9wdGlvbnMucnRsID09PSBmYWxzZSA/ICdyaWdodCcgOiAnbGVmdCcpOw0KICAgICAgICB9DQogICAgICAgIGlmIChfLm9wdGlvbnMudmVydGljYWxTd2lwaW5nID09PSB0cnVlKSB7DQogICAgICAgICAgICBpZiAoKHN3aXBlQW5nbGUgPj0gMzUpICYmIChzd2lwZUFuZ2xlIDw9IDEzNSkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gJ2Rvd24nOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gJ3VwJzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiAndmVydGljYWwnOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zd2lwZUVuZCA9IGZ1bmN0aW9uIChldmVudCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIHNsaWRlQ291bnQsDQogICAgICAgICAgICBkaXJlY3Rpb247DQoNCiAgICAgICAgXy5kcmFnZ2luZyA9IGZhbHNlOw0KICAgICAgICBfLmludGVycnVwdGVkID0gZmFsc2U7DQogICAgICAgIF8uc2hvdWxkQ2xpY2sgPSAoXy50b3VjaE9iamVjdC5zd2lwZUxlbmd0aCA+IDEwKSA/IGZhbHNlIDogdHJ1ZTsNCg0KICAgICAgICBpZiAoXy50b3VjaE9iamVjdC5jdXJYID09PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLnRvdWNoT2JqZWN0LmVkZ2VIaXQgPT09IHRydWUpIHsNCiAgICAgICAgICAgIF8uJHNsaWRlci50cmlnZ2VyKCdlZGdlJywgW18sIF8uc3dpcGVEaXJlY3Rpb24oKV0pOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKF8udG91Y2hPYmplY3Quc3dpcGVMZW5ndGggPj0gXy50b3VjaE9iamVjdC5taW5Td2lwZSkgew0KDQogICAgICAgICAgICBkaXJlY3Rpb24gPSBfLnN3aXBlRGlyZWN0aW9uKCk7DQoNCiAgICAgICAgICAgIHN3aXRjaCAoZGlyZWN0aW9uKSB7DQoNCiAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoNCiAgICAgICAgICAgICAgICBjYXNlICdkb3duJzoNCg0KICAgICAgICAgICAgICAgICAgICBzbGlkZUNvdW50ID0NCiAgICAgICAgICAgICAgICAgICAgICAgIF8ub3B0aW9ucy5zd2lwZVRvU2xpZGUgPw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uY2hlY2tOYXZpZ2FibGUoXy5jdXJyZW50U2xpZGUgKyBfLmdldFNsaWRlQ291bnQoKSkgOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uY3VycmVudFNsaWRlICsgXy5nZXRTbGlkZUNvdW50KCk7DQoNCiAgICAgICAgICAgICAgICAgICAgXy5jdXJyZW50RGlyZWN0aW9uID0gMDsNCg0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoNCiAgICAgICAgICAgICAgICBjYXNlICd1cCc6DQoNCiAgICAgICAgICAgICAgICAgICAgc2xpZGVDb3VudCA9DQogICAgICAgICAgICAgICAgICAgICAgICBfLm9wdGlvbnMuc3dpcGVUb1NsaWRlID8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmNoZWNrTmF2aWdhYmxlKF8uY3VycmVudFNsaWRlIC0gXy5nZXRTbGlkZUNvdW50KCkpIDoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmN1cnJlbnRTbGlkZSAtIF8uZ2V0U2xpZGVDb3VudCgpOw0KDQogICAgICAgICAgICAgICAgICAgIF8uY3VycmVudERpcmVjdGlvbiA9IDE7DQoNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICBkZWZhdWx0Og0KDQoNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiAhPSAndmVydGljYWwnKSB7DQoNCiAgICAgICAgICAgICAgICBfLnNsaWRlSGFuZGxlcihzbGlkZUNvdW50KTsNCiAgICAgICAgICAgICAgICBfLnRvdWNoT2JqZWN0ID0ge307DQogICAgICAgICAgICAgICAgXy4kc2xpZGVyLnRyaWdnZXIoJ3N3aXBlJywgW18sIGRpcmVjdGlvbl0pOw0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgfSBlbHNlIHsNCg0KICAgICAgICAgICAgaWYgKF8udG91Y2hPYmplY3Quc3RhcnRYICE9PSBfLnRvdWNoT2JqZWN0LmN1clgpIHsNCg0KICAgICAgICAgICAgICAgIF8uc2xpZGVIYW5kbGVyKF8uY3VycmVudFNsaWRlKTsNCiAgICAgICAgICAgICAgICBfLnRvdWNoT2JqZWN0ID0ge307DQoNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnN3aXBlSGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoKF8ub3B0aW9ucy5zd2lwZSA9PT0gZmFsc2UpIHx8ICgnb250b3VjaGVuZCcgaW4gZG9jdW1lbnQgJiYgXy5vcHRpb25zLnN3aXBlID09PSBmYWxzZSkpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfSBlbHNlIGlmIChfLm9wdGlvbnMuZHJhZ2dhYmxlID09PSBmYWxzZSAmJiBldmVudC50eXBlLmluZGV4T2YoJ21vdXNlJykgIT09IC0xKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBfLnRvdWNoT2JqZWN0LmZpbmdlckNvdW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCAmJiBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgIT09IHVuZGVmaW5lZCA/DQogICAgICAgICAgICBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMubGVuZ3RoIDogMTsNCg0KICAgICAgICBfLnRvdWNoT2JqZWN0Lm1pblN3aXBlID0gXy5saXN0V2lkdGggLyBfLm9wdGlvbnMNCiAgICAgICAgICAgIC50b3VjaFRocmVzaG9sZDsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLnZlcnRpY2FsU3dpcGluZyA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy50b3VjaE9iamVjdC5taW5Td2lwZSA9IF8ubGlzdEhlaWdodCAvIF8ub3B0aW9ucw0KICAgICAgICAgICAgICAgIC50b3VjaFRocmVzaG9sZDsNCiAgICAgICAgfQ0KDQogICAgICAgIHN3aXRjaCAoZXZlbnQuZGF0YS5hY3Rpb24pIHsNCg0KICAgICAgICAgICAgY2FzZSAnc3RhcnQnOg0KICAgICAgICAgICAgICAgIF8uc3dpcGVTdGFydChldmVudCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgIGNhc2UgJ21vdmUnOg0KICAgICAgICAgICAgICAgIF8uc3dpcGVNb3ZlKGV2ZW50KTsNCiAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgY2FzZSAnZW5kJzoNCiAgICAgICAgICAgICAgICBfLnN3aXBlRW5kKGV2ZW50KTsNCiAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnN3aXBlTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgew0KDQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIGVkZ2VXYXNIaXQgPSBmYWxzZSwNCiAgICAgICAgICAgIGN1ckxlZnQsIHN3aXBlRGlyZWN0aW9uLCBzd2lwZUxlbmd0aCwgcG9zaXRpb25PZmZzZXQsIHRvdWNoZXM7DQoNCiAgICAgICAgdG91Y2hlcyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09IHVuZGVmaW5lZCA/IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA6IG51bGw7DQoNCiAgICAgICAgaWYgKCFfLmRyYWdnaW5nIHx8IHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggIT09IDEpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGN1ckxlZnQgPSBfLmdldExlZnQoXy5jdXJyZW50U2xpZGUpOw0KDQogICAgICAgIF8udG91Y2hPYmplY3QuY3VyWCA9IHRvdWNoZXMgIT09IHVuZGVmaW5lZCA/IHRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5jbGllbnRYOw0KICAgICAgICBfLnRvdWNoT2JqZWN0LmN1clkgPSB0b3VjaGVzICE9PSB1bmRlZmluZWQgPyB0b3VjaGVzWzBdLnBhZ2VZIDogZXZlbnQuY2xpZW50WTsNCg0KICAgICAgICBfLnRvdWNoT2JqZWN0LnN3aXBlTGVuZ3RoID0gTWF0aC5yb3VuZChNYXRoLnNxcnQoDQogICAgICAgICAgICBNYXRoLnBvdyhfLnRvdWNoT2JqZWN0LmN1clggLSBfLnRvdWNoT2JqZWN0LnN0YXJ0WCwgMikpKTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLnZlcnRpY2FsU3dpcGluZyA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy50b3VjaE9iamVjdC5zd2lwZUxlbmd0aCA9IE1hdGgucm91bmQoTWF0aC5zcXJ0KA0KICAgICAgICAgICAgICAgIE1hdGgucG93KF8udG91Y2hPYmplY3QuY3VyWSAtIF8udG91Y2hPYmplY3Quc3RhcnRZLCAyKSkpOw0KICAgICAgICB9DQoNCiAgICAgICAgc3dpcGVEaXJlY3Rpb24gPSBfLnN3aXBlRGlyZWN0aW9uKCk7DQoNCiAgICAgICAgaWYgKHN3aXBlRGlyZWN0aW9uID09PSAndmVydGljYWwnKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gdW5kZWZpbmVkICYmIF8udG91Y2hPYmplY3Quc3dpcGVMZW5ndGggPiA0KSB7DQogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgcG9zaXRpb25PZmZzZXQgPSAoXy5vcHRpb25zLnJ0bCA9PT0gZmFsc2UgPyAxIDogLTEpICogKF8udG91Y2hPYmplY3QuY3VyWCA+IF8udG91Y2hPYmplY3Quc3RhcnRYID8gMSA6IC0xKTsNCiAgICAgICAgaWYgKF8ub3B0aW9ucy52ZXJ0aWNhbFN3aXBpbmcgPT09IHRydWUpIHsNCiAgICAgICAgICAgIHBvc2l0aW9uT2Zmc2V0ID0gXy50b3VjaE9iamVjdC5jdXJZID4gXy50b3VjaE9iamVjdC5zdGFydFkgPyAxIDogLTE7DQogICAgICAgIH0NCg0KDQogICAgICAgIHN3aXBlTGVuZ3RoID0gXy50b3VjaE9iamVjdC5zd2lwZUxlbmd0aDsNCg0KICAgICAgICBfLnRvdWNoT2JqZWN0LmVkZ2VIaXQgPSBmYWxzZTsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmluZmluaXRlID09PSBmYWxzZSkgew0KICAgICAgICAgICAgaWYgKChfLmN1cnJlbnRTbGlkZSA9PT0gMCAmJiBzd2lwZURpcmVjdGlvbiA9PT0gJ3JpZ2h0JykgfHwgKF8uY3VycmVudFNsaWRlID49IF8uZ2V0RG90Q291bnQoKSAmJiBzd2lwZURpcmVjdGlvbiA9PT0gJ2xlZnQnKSkgew0KICAgICAgICAgICAgICAgIHN3aXBlTGVuZ3RoID0gXy50b3VjaE9iamVjdC5zd2lwZUxlbmd0aCAqIF8ub3B0aW9ucy5lZGdlRnJpY3Rpb247DQogICAgICAgICAgICAgICAgXy50b3VjaE9iamVjdC5lZGdlSGl0ID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLm9wdGlvbnMudmVydGljYWwgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBfLnN3aXBlTGVmdCA9IGN1ckxlZnQgKyBzd2lwZUxlbmd0aCAqIHBvc2l0aW9uT2Zmc2V0Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgXy5zd2lwZUxlZnQgPSBjdXJMZWZ0ICsgKHN3aXBlTGVuZ3RoICogKF8uJGxpc3QuaGVpZ2h0KCkgLyBfLmxpc3RXaWR0aCkpICogcG9zaXRpb25PZmZzZXQ7DQogICAgICAgIH0NCiAgICAgICAgaWYgKF8ub3B0aW9ucy52ZXJ0aWNhbFN3aXBpbmcgPT09IHRydWUpIHsNCiAgICAgICAgICAgIF8uc3dpcGVMZWZ0ID0gY3VyTGVmdCArIHN3aXBlTGVuZ3RoICogcG9zaXRpb25PZmZzZXQ7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmZhZGUgPT09IHRydWUgfHwgXy5vcHRpb25zLnRvdWNoTW92ZSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLmFuaW1hdGluZyA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgXy5zd2lwZUxlZnQgPSBudWxsOw0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgXy5zZXRDU1MoXy5zd2lwZUxlZnQpOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS5zd2lwZVN0YXJ0ID0gZnVuY3Rpb24gKGV2ZW50KSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgdG91Y2hlczsNCg0KICAgICAgICBfLmludGVycnVwdGVkID0gdHJ1ZTsNCg0KICAgICAgICBpZiAoXy50b3VjaE9iamVjdC5maW5nZXJDb3VudCAhPT0gMSB8fCBfLnNsaWRlQ291bnQgPD0gXy5vcHRpb25zLnNsaWRlc1RvU2hvdykgew0KICAgICAgICAgICAgXy50b3VjaE9iamVjdCA9IHt9Ow0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09IHVuZGVmaW5lZCAmJiBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgdG91Y2hlcyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1swXTsNCiAgICAgICAgfQ0KDQogICAgICAgIF8udG91Y2hPYmplY3Quc3RhcnRYID0gXy50b3VjaE9iamVjdC5jdXJYID0gdG91Y2hlcyAhPT0gdW5kZWZpbmVkID8gdG91Y2hlcy5wYWdlWCA6IGV2ZW50LmNsaWVudFg7DQogICAgICAgIF8udG91Y2hPYmplY3Quc3RhcnRZID0gXy50b3VjaE9iamVjdC5jdXJZID0gdG91Y2hlcyAhPT0gdW5kZWZpbmVkID8gdG91Y2hlcy5wYWdlWSA6IGV2ZW50LmNsaWVudFk7DQoNCiAgICAgICAgXy5kcmFnZ2luZyA9IHRydWU7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnVuZmlsdGVyU2xpZGVzID0gU2xpY2sucHJvdG90eXBlLnNsaWNrVW5maWx0ZXIgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzOw0KDQogICAgICAgIGlmIChfLiRzbGlkZXNDYWNoZSAhPT0gbnVsbCkgew0KDQogICAgICAgICAgICBfLnVubG9hZCgpOw0KDQogICAgICAgICAgICBfLiRzbGlkZVRyYWNrLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5zbGlkZSkuZGV0YWNoKCk7DQoNCiAgICAgICAgICAgIF8uJHNsaWRlc0NhY2hlLmFwcGVuZFRvKF8uJHNsaWRlVHJhY2spOw0KDQogICAgICAgICAgICBfLnJlaW5pdCgpOw0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUudW5sb2FkID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICAkKCcuc2xpY2stY2xvbmVkJywgXy4kc2xpZGVyKS5yZW1vdmUoKTsNCg0KICAgICAgICBpZiAoXy4kZG90cykgew0KICAgICAgICAgICAgXy4kZG90cy5yZW1vdmUoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChfLiRwcmV2QXJyb3cgJiYgXy5odG1sRXhwci50ZXN0KF8ub3B0aW9ucy5wcmV2QXJyb3cpKSB7DQogICAgICAgICAgICBfLiRwcmV2QXJyb3cucmVtb3ZlKCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoXy4kbmV4dEFycm93ICYmIF8uaHRtbEV4cHIudGVzdChfLm9wdGlvbnMubmV4dEFycm93KSkgew0KICAgICAgICAgICAgXy4kbmV4dEFycm93LnJlbW92ZSgpOw0KICAgICAgICB9DQoNCiAgICAgICAgXy4kc2xpZGVzDQogICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3NsaWNrLXNsaWRlIHNsaWNrLWFjdGl2ZSBzbGljay12aXNpYmxlIHNsaWNrLWN1cnJlbnQnKQ0KICAgICAgICAgICAgLmF0dHIoJ2FyaWEtaGlkZGVuJywgJ3RydWUnKQ0KICAgICAgICAgICAgLmNzcygnd2lkdGgnLCAnJyk7DQoNCiAgICB9Ow0KDQogICAgU2xpY2sucHJvdG90eXBlLnVuc2xpY2sgPSBmdW5jdGlvbiAoZnJvbUJyZWFrcG9pbnQpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQogICAgICAgIF8uJHNsaWRlci50cmlnZ2VyKCd1bnNsaWNrJywgW18sIGZyb21CcmVha3BvaW50XSk7DQogICAgICAgIF8uZGVzdHJveSgpOw0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS51cGRhdGVBcnJvd3MgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgdmFyIF8gPSB0aGlzLA0KICAgICAgICAgICAgY2VudGVyT2Zmc2V0Ow0KDQogICAgICAgIGNlbnRlck9mZnNldCA9IE1hdGguZmxvb3IoXy5vcHRpb25zLnNsaWRlc1RvU2hvdyAvIDIpOw0KDQogICAgICAgIGlmIChfLm9wdGlvbnMuYXJyb3dzID09PSB0cnVlICYmDQogICAgICAgICAgICBfLnNsaWRlQ291bnQgPiBfLm9wdGlvbnMuc2xpZGVzVG9TaG93ICYmDQogICAgICAgICAgICAhXy5vcHRpb25zLmluZmluaXRlKSB7DQoNCiAgICAgICAgICAgIF8uJHByZXZBcnJvdy5yZW1vdmVDbGFzcygnc2xpY2stZGlzYWJsZWQnKS5hdHRyKCdhcmlhLWRpc2FibGVkJywgJ2ZhbHNlJyk7DQogICAgICAgICAgICBfLiRuZXh0QXJyb3cucmVtb3ZlQ2xhc3MoJ3NsaWNrLWRpc2FibGVkJykuYXR0cignYXJpYS1kaXNhYmxlZCcsICdmYWxzZScpOw0KDQogICAgICAgICAgICBpZiAoXy5jdXJyZW50U2xpZGUgPT09IDApIHsNCg0KICAgICAgICAgICAgICAgIF8uJHByZXZBcnJvdy5hZGRDbGFzcygnc2xpY2stZGlzYWJsZWQnKS5hdHRyKCdhcmlhLWRpc2FibGVkJywgJ3RydWUnKTsNCiAgICAgICAgICAgICAgICBfLiRuZXh0QXJyb3cucmVtb3ZlQ2xhc3MoJ3NsaWNrLWRpc2FibGVkJykuYXR0cignYXJpYS1kaXNhYmxlZCcsICdmYWxzZScpOw0KDQogICAgICAgICAgICB9IGVsc2UgaWYgKF8uY3VycmVudFNsaWRlID49IF8uc2xpZGVDb3VudCAtIF8ub3B0aW9ucy5zbGlkZXNUb1Nob3cgJiYgXy5vcHRpb25zLmNlbnRlck1vZGUgPT09IGZhbHNlKSB7DQoNCiAgICAgICAgICAgICAgICBfLiRuZXh0QXJyb3cuYWRkQ2xhc3MoJ3NsaWNrLWRpc2FibGVkJykuYXR0cignYXJpYS1kaXNhYmxlZCcsICd0cnVlJyk7DQogICAgICAgICAgICAgICAgXy4kcHJldkFycm93LnJlbW92ZUNsYXNzKCdzbGljay1kaXNhYmxlZCcpLmF0dHIoJ2FyaWEtZGlzYWJsZWQnLCAnZmFsc2UnKTsNCg0KICAgICAgICAgICAgfSBlbHNlIGlmIChfLmN1cnJlbnRTbGlkZSA+PSBfLnNsaWRlQ291bnQgLSAxICYmIF8ub3B0aW9ucy5jZW50ZXJNb2RlID09PSB0cnVlKSB7DQoNCiAgICAgICAgICAgICAgICBfLiRuZXh0QXJyb3cuYWRkQ2xhc3MoJ3NsaWNrLWRpc2FibGVkJykuYXR0cignYXJpYS1kaXNhYmxlZCcsICd0cnVlJyk7DQogICAgICAgICAgICAgICAgXy4kcHJldkFycm93LnJlbW92ZUNsYXNzKCdzbGljay1kaXNhYmxlZCcpLmF0dHIoJ2FyaWEtZGlzYWJsZWQnLCAnZmFsc2UnKTsNCg0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBTbGljay5wcm90b3R5cGUudXBkYXRlRG90cyA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICB2YXIgXyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKF8uJGRvdHMgIT09IG51bGwpIHsNCg0KICAgICAgICAgICAgXy4kZG90cw0KICAgICAgICAgICAgICAgIC5maW5kKCdsaScpDQogICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdzbGljay1hY3RpdmUnKQ0KICAgICAgICAgICAgICAgIC5hdHRyKCdhcmlhLWhpZGRlbicsICd0cnVlJyk7DQoNCiAgICAgICAgICAgIF8uJGRvdHMNCiAgICAgICAgICAgICAgICAuZmluZCgnbGknKQ0KICAgICAgICAgICAgICAgIC5lcShNYXRoLmZsb29yKF8uY3VycmVudFNsaWRlIC8gXy5vcHRpb25zLnNsaWRlc1RvU2Nyb2xsKSkNCiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3NsaWNrLWFjdGl2ZScpDQogICAgICAgICAgICAgICAgLmF0dHIoJ2FyaWEtaGlkZGVuJywgJ2ZhbHNlJyk7DQoNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIFNsaWNrLnByb3RvdHlwZS52aXNpYmlsaXR5ID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIHZhciBfID0gdGhpczsNCg0KICAgICAgICBpZiAoXy5vcHRpb25zLmF1dG9wbGF5KSB7DQoNCiAgICAgICAgICAgIGlmIChkb2N1bWVudFtfLmhpZGRlbl0pIHsNCg0KICAgICAgICAgICAgICAgIF8uaW50ZXJydXB0ZWQgPSB0cnVlOw0KDQogICAgICAgICAgICB9IGVsc2Ugew0KDQogICAgICAgICAgICAgICAgXy5pbnRlcnJ1cHRlZCA9IGZhbHNlOw0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgICQuZm4uc2xpY2sgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBfID0gdGhpcywNCiAgICAgICAgICAgIG9wdCA9IGFyZ3VtZW50c1swXSwNCiAgICAgICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLA0KICAgICAgICAgICAgbCA9IF8ubGVuZ3RoLA0KICAgICAgICAgICAgaSwNCiAgICAgICAgICAgIHJldDsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykgew0KICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHQgPT0gJ29iamVjdCcgfHwgdHlwZW9mIG9wdCA9PSAndW5kZWZpbmVkJykNCiAgICAgICAgICAgICAgICBfW2ldLnNsaWNrID0gbmV3IFNsaWNrKF9baV0sIG9wdCk7DQogICAgICAgICAgICBlbHNlDQogICAgICAgICAgICAgICAgcmV0ID0gX1tpXS5zbGlja1tvcHRdLmFwcGx5KF9baV0uc2xpY2ssIGFyZ3MpOw0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZXQgIT0gJ3VuZGVmaW5lZCcpIHJldHVybiByZXQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF87DQogICAgfTsNCg0KfSkpOw==
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 87514
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20180204T141646Z
